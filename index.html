<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Primary Meta Tags -->
    <title>Wingman - Sistem Deposit Dokter</title>
    <meta name="title" content="Wingman - Sistem Deposit Dokter" />
    <meta name="description"
        content="Solusi modern untuk mengelola keuangan dokter secara efisien dan praktis. Data Anda tersimpan dengan aman dan terenkripsi di Google Cloud." />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://deposit-dokter-eta.vercel.app/" />
    <meta property="og:title" content="Wingman - Sistem Deposit Dokter" />
    <meta property="og:description"
        content="Solusi modern untuk mengelola keuangan dokter secara efisien dan praktis. Data Anda tersimpan dengan aman dan terenkripsi di Google Cloud." />
    <meta property="og:image" content="https://deposit-dokter-eta.vercel.app/WM1.jpg" />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content="https://deposit-dokter-eta.vercel.app/" />
    <meta property="twitter:title" content="Wingman - Sistem Deposit Dokter" />
    <meta property="twitter:description"
        content="Solusi modern untuk mengelola keuangan dokter secara efisien dan praktis. Data Anda tersimpan dengan aman dan terenkripsi di Google Cloud." />
    <meta property="twitter:image" content="https://deposit-dokter-eta.vercel.app/WM1.jpg" />

    <!-- Meta Tags Generated with https://metatags.io -->

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Ikon (Feather Icons) -->
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        /* ===== PRESET & UTILITIES ===== */
        :root {
            --primary-color: #4f46e5;
            /* Indigo-600 from Tailwind */
            --primary-hover: #4338ca;
            /* Indigo-700 */
            --secondary-color: #64748b;
            /* Slate-500 */
            --background-color: #f1f5f9;
            /* Slate-100 */
            --card-background: #ffffff;
            --text-primary: #1e293b;
            /* Slate-800 */
            --text-secondary: #64748b;
            /* Slate-500 */
            --border-color: #e2e8f0;
            /* Slate-200 */
            --green: #10b981;
            /* Emerald-500 */
            --red: #ef4444;
            /* Red-500 */
            --yellow: #f59e0b;
            /* Amber-500 */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body.drawer-open {
            overflow: hidden;
            /* Prevent scrolling of main content when drawer is open */
        }


        /* ===== LOGIN SCREEN STYLES ===== */
        .login-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--background-color);
            text-align: center;
            padding: 20px;
        }

        .login-card {
            background: var(--card-background);
            padding: 40px 30px;
            border-radius: 20px;
            /* Increased border-radius */
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
            /* Softer shadow */
            color: var(--text-primary);
            max-width: 400px;
            width: 100%;
        }

        .login-card h1 {
            font-size: 1.8rem;
            /* Slightly smaller */
            margin-bottom: 10px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .login-card p {
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-size: 1rem;
            /* Standardized size */
        }

        .google-login-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: #4285f4;
            /* Google Blue */
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            /* Rounded button */
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            text-decoration: none;
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
            /* Button shadow */
        }

        .google-login-btn:hover {
            background: #3367d6;
            /* Darker Google Blue on hover */
        }

        .google-icon {
            width: 20px;
            height: 20px;
        }

        /* ===== LOADING & CONNECTION STATUS ===== */
        .loading {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: var(--background-color);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .connection-status {
            position: fixed;
            bottom: 20px;
            /* Positioned at bottom-left */
            left: 20px;
            padding: 8px 12px;
            border-radius: 25px;
            /* Pill shape */
            font-size: 13px;
            font-weight: 500;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .connection-status.online {
            background: var(--green);
            color: white;
        }

        .connection-status.offline {
            background: var(--red);
            color: white;
        }

        .connection-status.syncing {
            background: var(--yellow);
            color: white;
        }

        /* ===== MAIN APP LAYOUT ===== */
        .app-layout {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 260px;
            background-color: var(--card-background);
            padding: 24px;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease-in-out;
            /* Smooth transition for drawer */
            z-index: 1002;
            /* Ensure sidebar is above content but below overlay if used */
        }

        .sidebar-header {
            margin-bottom: 20px;
            /* Adjusted margin */
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-header h1 {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .sidebar-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            padding-left: 5px;
            /* Slight indent for title */
        }

        /* Dokter Dropdown Styles */
        .dokter-dropdown-container {
            position: relative;
            margin-bottom: 20px;
        }

        .dokter-dropdown-active {
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
        }

        .dokter-dropdown-active i {
            transition: transform 0.2s ease-in-out;
        }

        .dokter-dropdown-active.open i {
            transform: rotate(180deg);
        }

        .dokter-dropdown-list-wrapper {
            display: none;
            position: absolute;
            top: calc(100% + 5px);
            left: 0;
            right: 0;
            /* This makes it take full width of parent */
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 10;
            padding: 10px;
            max-height: 300px;
            /* For scrollability */
        }

        .dokter-dropdown-list-wrapper.open {
            display: block;
        }

        #dokterSearchInput {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        #doctorList {
            /* Re-styled for dropdown context */
            list-style: none;
            margin: 0;
            padding: 0;
            max-height: 260px;
            /* Diubah dari 200px untuk menampilkan lebih banyak item */
            overflow-y: auto;
        }

        #doctorList li {
            padding: 10px;
            border-radius: 6px;
        }

        #doctorList li:hover,
        #doctorList li.highlighted {
            background-color: #f8fafc;
            color: var(--primary-color);
        }

        #doctorList li.active-selection {
            /* For the currently selected doctor IN THE DROPDOWN, not the global active doctor */
            background-color: var(--primary-color) !important;
            color: white !important;
        }

        #doctorList .doctor-list-empty-state {
            /* Adjusted for dropdown */
            padding: 10px;
            font-size: 0.85rem;
            border: none;
            min-height: auto;
        }

        #doctorList .doctor-list-empty-state i {
            display: none;
        }

        /* Hide icon in dropdown empty state */

        .sidebar-actions {
            margin-top: auto;
            /* Pushes this div to the bottom of the sidebar */
            padding-top: 20px;
            /* Space above action buttons */
            border-top: 1px solid var(--border-color);
            /* Separator line */
        }

        .sidebar-actions .btn {
            width: 100%;
            margin-top: 10px;
        }

        .sidebar-actions .btn:first-child {
            margin-top: 0;
        }

        #deleteDoctorBtn {
            display: none;
            /* Initially hidden, JS will control visibility */
        }

        #logoutBtnSidebar {
            display: none;
            /* Hidden by default, shown on mobile drawer */
        }


        .main-content {
            flex: 1;
            padding: 24px 32px;
            /* Standard padding */
            overflow-y: auto;
            /* Scroll for main content if needed */
            position: relative;
            /* For potential overlay or other positioned elements */
        }

        .main-content-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 1001;
            /* Below sidebar drawer, above main content */
        }

        body.drawer-open .main-content-overlay {
            display: block;
        }


        /* ===== HEADER ===== */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .header h2 {
            /* Main page title */
            font-size: 1.8rem;
            font-weight: 700;
        }

        .header p {
            /* Subtitle for page */
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .header-title-block {
            /* Wrapper for h2 and p */
            flex-grow: 1;
            /* Allows title block to take space */
        }

        .hamburger-btn {
            display: none;
            /* Hidden by default, shown on mobile */
            background: none;
            border: none;
            color: var(--text-primary);
            padding: 8px;
            cursor: pointer;
            margin-right: 10px;
            /* Space between hamburger and title */
        }

        .hamburger-btn i {
            width: 24px;
            height: 24px;
        }


        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
            /* Prevent user-info from shrinking */
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--primary-color);
            object-fit: cover;
            /* Ensure avatar image fits well */
        }

        .logout-btn-desktop {
            /* Renamed for clarity */
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 8px;
            /* Make it easier to click */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logout-btn-desktop:hover {
            background-color: #f1f5f9;
            /* Light background on hover */
            color: var(--primary-color);
        }

        /* ===== STAT CARDS (BALANCE) ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            /* Responsive grid */
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--card-background);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 8px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.07);
        }

        .stat-card-title {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .stat-card-value {
            font-size: 1.7rem;
            font-weight: 700;
        }

        #remainingBalance.negative {
            color: var(--red);
        }

        #remainingBalance.positive {
            color: var(--green);
        }

        /* ===== ACTION BUTTONS & FORMS ===== */
        .actions-bar {
            background: var(--card-background);
            padding: 16px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            /* Allow buttons to wrap on smaller screens */
            align-items: center;
            margin-bottom: 24px;
            /* Added margin */
        }

        .btn {
            display: inline-flex;
            /* Use inline-flex for better alignment */
            align-items: center;
            justify-content: center;
            /* Center content in button */
            gap: 8px;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            white-space: nowrap;
            /* Prevent button text from wrapping */
        }

        .btn i {
            /* Style for Feather icons in buttons */
            width: 16px;
            height: 16px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-success {
            background: var(--green);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        /* Darker green */
        .btn-danger {
            background: var(--red);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        /* Darker red */
        .btn-outline {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .btn-outline:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
        }

        /* Slate-300 */
        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        .btn-icon {
            /* For icon-only buttons like edit/delete in table */
            padding: 6px;
            width: 32px;
            /* Fixed width */
            height: 32px;
            /* Fixed height */
            flex-shrink: 0;
            /* Prevent shrinking */
        }

        .btn-icon i {
            margin: 0;
            /* No gap for icon-only buttons */
        }


        .expense-form-card {
            /* This class might be removed if form is only in modal */
            background: var(--card-background);
            padding: 24px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            margin-top: 24px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select {
            /* Apply to select as well */
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            background-color: white;
            /* Ensure select has white background */
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px #c7d2fe;
            /* Indigo-200 focus ring */
        }

        .input-with-icon {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-with-icon input {
            padding-right: 40px;
            /* Space for the icon */
        }

        .input-with-icon .calculator-trigger-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--secondary-color);
        }

        .input-with-icon .calculator-trigger-icon:hover {
            color: var(--primary-color);
        }

        /* Transaction Filters */
        .filter-controls-header {
            display: flex;
            justify-content: flex-end;
            /* Aligns button to the right */
            margin-bottom: 10px;
        }

        #toggleFilterBtn {
            /* Using existing .btn and .btn-outline styles, can be more specific if needed */
        }

        .transaction-filters {
            display: none;
            /* Hidden by default */
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            padding: 15px;
            background-color: var(--card-background);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .transaction-filters.open {
            display: flex;
            /* Show when .open class is added */
        }

        .transaction-filters .form-group {
            margin-bottom: 0;
            flex: 1;
            min-width: 180px;
        }

        .transaction-filters label {
            font-size: 0.85rem;
            margin-bottom: 4px;
        }

        .transaction-filters input,
        .transaction-filters select {
            padding: 8px 10px;
            font-size: 0.9rem;
        }


        /* ===== TRANSACTIONS TABLE ===== */
        .transactions-card {
            background: var(--card-background);
            padding: 24px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            margin-top: 0;
            /* Removed margin-top as filters are now above */
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            /* Allow wrapping for smaller screens */
            gap: 10px;
            /* Gap between title and sort dropdown */
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            flex-grow: 1;
            /* Allow title to take available space */
        }

        .sort-transactions-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sort-transactions-control label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .sort-transactions-control select {
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            font-size: 0.9rem;
            background-color: white;
            min-width: 180px;
            /* Adjust as needed */
        }


        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border-color);
            /* Thicker bottom border for header */
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        th.no-column {
            /* Style for "No." column */
            width: 50px;
            /* Adjust width as needed */
            text-align: center;
        }

        th.actions-column {
            /* Style for "Tindakan" column */
            width: 100px;
            /* Adjust width to fit two icon buttons */
            text-align: right;
            /* Align header text to right */
        }


        td {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
            vertical-align: middle;
        }

        td.no-column {
            text-align: center;
        }

        td.actions-column-cell {
            /* New class for the TD containing actions */
            text-align: center;
            /* Default center alignment for the wrapper */
            vertical-align: middle;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover td {
            background-color: #f8fafc;
        }

        /* Row hover effect */

        .amount-cell {
            font-weight: 600;
            text-align: right;
        }

        .income-amount {
            color: var(--green);
        }

        .expense-amount {
            color: var(--red);
        }

        .description-cell {
            max-width: 250px;
            /* Limit width */
            /* white-space: nowrap;  Allow wrapping for better readability */
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: default;
            /* Indicate it's hoverable for full text if implemented */
        }

        .transaction-actions-wrapper {
            /* Wrapper for action buttons */
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            /* Default to right on desktop */
            align-items: center;
        }

        .edit-btn {
            background: #e0e7ff;
            /* Indigo-100 */
            color: var(--primary-color);
        }

        .edit-btn:hover {
            background: var(--primary-color);
            color: white;
        }

        .delete-btn {
            background: #fee2e2;
            /* Red-100 */
            color: var(--red);
        }

        .delete-btn:hover {
            background: var(--red);
            color: white;
        }

        .delete-btn i,
        .edit-btn i {
            width: 14px;
            height: 14px;
        }

        /* Transaction Summary Totals */
        .transaction-summary {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            font-weight: 600;
        }

        .transaction-summary div {
            font-size: 0.95rem;
        }

        .summary-income {
            color: var(--green);
        }

        .summary-expense {
            color: var(--red);
        }


        /* Pagination Styles */
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            gap: 8px;
        }

        .pagination-controls .btn {
            min-width: 36px;
            /* Ensure buttons have a decent size */
        }

        .pagination-controls .btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .pagination-controls .btn:disabled {
            background-color: var(--border-color);
            color: var(--text-secondary);
            cursor: not-allowed;
            opacity: 0.7;
        }

        .page-info {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin: 0 10px;
        }


        /* ===== EMPTY STATE & MODAL ===== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            background-color: #fdfdff;
            /* Slightly off-white */
        }

        .empty-state i {
            width: 48px;
            height: 48px;
            margin-bottom: 16px;
            color: var(--secondary-color);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(30, 41, 59, 0.5);
            /* Slate-800 with opacity */
            z-index: 1000;
            display: none;
            /* Hidden by default */
            align-items: center;
            justify-content: center;
            padding: 20px;
            /* Padding for smaller screens */
        }

        .modal.show {
            display: flex;
        }

        /* Class to show modal */

        .modal-content {
            background: white;
            padding: 30px;
            width: 100%;
            /* Full width on small screens */
            max-width: 450px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-content h3 {
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 30px;
            justify-content: flex-end;
        }

        /* ===== CALCULATOR MODAL STYLES ===== */
        .calculator-content {
            max-width: 320px;
            /* Smaller width for calculator */
            padding: 20px;
        }

        .calculator-display-container {
            margin-bottom: 15px;
        }

        #calculatorDisplay {
            width: 100%;
            padding: 12px;
            font-size: 1.8rem;
            text-align: right;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: #f8fafc;
            /* Light background for display */
            color: var(--text-primary);
            font-family: 'Inter', monospace;
            /* Monospace for better number alignment */
        }

        .calculator-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .calculator-buttons button {
            padding: 15px;
            font-size: 1.2rem;
            font-weight: 500;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: #f9fafb;
            /* Light gray for buttons */
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .calculator-buttons button:hover {
            background-color: #f1f5f9;
            /* Slightly darker on hover */
        }

        .calculator-buttons button.operator {
            background-color: #e2e8f0;
            /* Different color for operators */
            color: var(--primary-color);
        }

        .calculator-buttons button.operator:hover {
            background-color: #cbd5e1;
        }

        .calculator-buttons button.primary {
            /* For OK/Apply button */
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .calculator-buttons button.primary:hover {
            background-color: var(--primary-hover);
        }

        .calculator-buttons button.danger {
            /* For C/Clear button */
            background-color: #fee2e2;
            /* Light red */
            color: var(--red);
        }

        .calculator-buttons button.danger:hover {
            background-color: #fecaca;
            /* Darker light red */
        }

        .calculator-buttons .span-2 {
            grid-column: span 2;
        }


        /* ===== NOTIFICATION ===== */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 2000;
            transform: translateX(calc(100% + 20px));
            /* Start off-screen */
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: var(--green);
        }

        .notification.error {
            background: var(--red);
        }

        .notification.info {
            background: #3b82f6;
        }

        /* Blue-500 */

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 992px) {

            /* Tablet and below */
            .sidebar {
                position: fixed;
                /* Changed for drawer behavior */
                top: 0;
                left: 0;
                height: 100%;
                transform: translateX(-100%);
                /* Initially hidden off-screen */
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
                border-right: none;
                /* No border when it's a drawer */
            }

            .sidebar.open {
                transform: translateX(0);
                /* Slide in when open */
            }

            #doctorList {
                display: block;
                /* Revert to block for vertical scrolling in drawer */
                overflow-x: hidden;
                overflow-y: auto;
                white-space: normal;
            }

            #doctorList li {
                min-width: auto;
                /* Reset min-width */
            }

            /* REMOVED specific width for .dokter-dropdown-list-wrapper on mobile */
            /* .dokter-dropdown-list-wrapper {
                width: calc(100% - 48px); /* Adjust width within sidebar padding */
            /* } */


            .main-content {
                padding: 20px;
            }

            .header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }

            .hamburger-btn {
                display: inline-flex;
                /* Show hamburger on mobile */
            }

            .user-info .logout-btn-desktop {
                display: none;
                /* Hide desktop logout button on mobile */
            }

            .sidebar-actions #logoutBtnSidebar {
                display: inline-flex;
                /* Show sidebar logout button when sidebar is open (mobile) */
            }

            .transaction-filters {
                flex-direction: column;
                /* Stack filters on smaller screens */
            }

            .transaction-filters .form-group {
                min-width: 100%;
                /* Full width for filter items on stack */
                margin-bottom: 10px;
                /* Add margin back when stacked */
            }

            .transaction-filters .form-group:last-child {
                margin-bottom: 0;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
                /* Align items to the start for column layout */
            }

            .sort-transactions-control {
                width: 100%;
                /* Make sort control take full width on smaller screens */
                margin-top: 10px;
            }

            .sort-transactions-control select {
                width: 100%;
                /* Select takes full width of its container */
            }
        }

        @media (max-width: 600px) {

            /* Mobile */
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .actions-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }

            .main-content {
                padding: 15px;
            }

            .header h2 {
                font-size: 1.5rem;
            }

            .header p {
                display: none;
            }

            /* Hide subtitle on very small screens */
            td,
            th {
                padding: 10px 8px;
                font-size: 0.85rem;
            }

            .actions-bar .btn {
                width: 100%;
            }

            .actions-bar .btn-danger {
                width: 100%;
                margin-left: 0;
            }

            .modal-buttons .btn {
                width: auto;
            }

            .sidebar .sidebar-actions .btn {
                width: 100%;
            }

            .pagination-controls {
                flex-wrap: wrap;
                /* Allow pagination buttons to wrap */
                justify-content: center;
            }

            .pagination-controls .btn {
                padding: 8px 12px;
                /* Slightly smaller buttons on mobile */
            }

            th.actions-column {
                text-align: center;
                min-width: 80px;
                width: auto;
            }

            td.actions-column-cell .transaction-actions-wrapper {
                justify-content: center;
            }

            .transaction-actions-wrapper .btn-icon {
                padding: 5px;
                width: 28px;
                height: 28px;
            }

            .transaction-actions-wrapper .btn-icon i {
                width: 12px;
                height: 12px;
            }

            .calculator-content {
                max-width: 100%;
                /* Full width on small screens for calculator */
                padding: 15px;
            }

            .calculator-buttons button {
                padding: 12px;
                font-size: 1.1rem;
            }

            .transaction-summary {
                flex-direction: column;
                gap: 8px;
                align-items: flex-start;
            }
        }
    </style>
</head>

<body>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading">
        <div class="loading-spinner"></div>
        <p>Memuat aplikasi...</p>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen" style="display: none;">
        <div class="login-card">
            <h1><i data-feather="github"></i>WINGMAN!</h1>
            <p>Solusi modern untuk mengelola keuangan dokter secara praktis.</p>
            <button id="googleLoginBtn" class="google-login-btn">
                <img src="https://www.google.com/images/branding/googleg/1x/googleg_standard_color_28dp.png" alt="G"
                    class="google-icon" />
                Masuk dengan Google
            </button>
            <div style="margin-top: 20px; font-size: 0.9rem; color: #94a3b8;">
                Data Anda aman dan tersinkronisasi secara otomatis di Google Cloud.
            </div>
        </div>
    </div>

    <!-- Main Application Layout -->
    <div id="mainApp" class="app-layout" style="display: none;">
        <!-- Sidebar / Drawer -->
        <aside id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <i data-feather="github" style="color: var(--primary-color); width:28px; height:28px;"></i>
                <h1>WINGMAN!</h1>
            </div>

            <p class="sidebar-title">Pilih Dokter</p>
            <div class="dokter-dropdown-container">
                <div id="dokterDropdownActive" class="dokter-dropdown-active">
                    <span id="activeDokterName">Pilih Dokter...</span>
                    <i data-feather="chevron-down"></i>
                </div>
                <div id="dokterDropdownListWrapper" class="dokter-dropdown-list-wrapper">
                    <input type="text" id="dokterSearchInput" placeholder="Cari dokter...">
                    <ul id="doctorList">
                        <!-- Doctor list will be populated by JavaScript -->
                    </ul>
                </div>
            </div>

            <div class="sidebar-actions">
                <button class="btn btn-primary" id="addDoctorSidebarBtn">
                    <i data-feather="plus-circle"></i> Tambah Dokter Baru
                </button>
                <button class="btn btn-danger" onclick="showDeleteDoctorModal()" id="deleteDoctorBtn">
                    <i data-feather="trash-2"></i> Hapus Dokter Terpilih
                </button>
                <button class="btn btn-outline" id="logoutBtnSidebar" onclick="signOut()">
                    <i data-feather="log-out"></i> Keluar
                </button>
            </div>
        </aside>
        <div id="mainContentOverlay" class="main-content-overlay"></div>


        <!-- Main Content Area -->
        <main id="mainContent" class="main-content">
            <!-- Header Section -->
            <header class="header">
                <button id="hamburgerBtn" class="hamburger-btn">
                    <i data-feather="menu"></i>
                </button>
                <div class="header-title-block">
                    <h2 id="welcomeHeader">Dasbor Utama</h2>
                    <p id="welcomeSubheader">Selamat datang! Pilih dokter untuk memulai.</p>
                </div>
                <div class="user-info">
                    <img id="userAvatar" class="user-avatar" src="" alt="Foto Pengguna">
                    <button id="logoutBtnDesktop" class="logout-btn-desktop" title="Keluar" onclick="signOut()">
                        <i data-feather="log-out"></i>
                    </button>
                </div>
            </header>

            <!-- Placeholder for when no doctor is selected -->
            <div id="noDoctorSelected" class="empty-state">
                <i data-feather="users"></i>
                <h3>Pilih atau Tambah Dokter</h3>
                <p>Untuk melihat detail keuangan, silakan pilih dokter dari daftar di samping atau tambahkan dokter
                    baru.</p>
            </div>

            <!-- Doctor-specific content (shown when a doctor is selected) -->
            <div id="doctorInfo" style="display: none;">
                <!-- Balance Statistics Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="stat-card-title">Total Deposit Diterima</span>
                        <span class="stat-card-value" id="totalDeposit">Rp 0</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-card-title">Total Pengeluaran Dicatat</span>
                        <span class="stat-card-value" id="totalExpense">Rp 0</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-card-title">Sisa Saldo Saat Ini</span>
                        <span class="stat-card-value" id="remainingBalance">Rp 0</span>
                    </div>
                </div>

                <!-- Action Bar -->
                <div class="actions-bar">
                    <button class="btn btn-success" onclick="showAddDepositModal()">
                        <i data-feather="arrow-down-circle"></i> Tambah Deposit
                    </button>
                    <button class="btn btn-primary" id="addExpenseModalBtn" onclick="showAddExpenseModal()">
                        <i data-feather="arrow-up-circle"></i> Tambah Pengeluaran
                    </button>
                    <button class="btn btn-outline" onclick="showExportModal()">
                        <i data-feather="file-text"></i> Export Laporan
                    </button>
                </div>

                <!-- Filter Controls Header -->
                <div class="filter-controls-header">
                    <button id="toggleFilterBtn" class="btn btn-outline btn-sm">
                        <i data-feather="filter"></i> <span>Tampilkan Filter</span>
                    </button>
                </div>
                <!-- Transaction Filters -->
                <div id="transactionFilters" class="transaction-filters">
                    <div class="form-group">
                        <label for="searchKeterangan">Cari Keterangan</label>
                        <input type="text" id="searchKeterangan" placeholder="Contoh: Beli makan...">
                    </div>
                    <div class="form-group">
                        <label for="filterTanggalMulai">Tanggal Mulai</label>
                        <input type="date" id="filterTanggalMulai">
                    </div>
                    <div class="form-group">
                        <label for="filterTanggalAkhir">Tanggal Akhir</label>
                        <input type="date" id="filterTanggalAkhir">
                    </div>
                    <div class="form-group">
                        <label for="filterJenisTransaksi">Jenis Transaksi</label>
                        <select id="filterJenisTransaksi">
                            <option value="semua">Semua Jenis</option>
                            <option value="income">Pemasukan</option>
                            <option value="expense">Pengeluaran</option>
                        </select>
                    </div>
                </div>


                <!-- Transactions Table Card -->
                <div id="transactionsSection" class="transactions-card">
                    <div class="section-header">
                        <h3 class="section-title">Riwayat Transaksi Keuangan</h3>
                        <div class="sort-transactions-control">
                            <label for="sortTransaksi">Urutkan:</label>
                            <select id="sortTransaksi">
                                <option value="date-desc">Tanggal Terbaru</option>
                                <option value="date-asc">Tanggal Terlama</option>
                                <option value="created-desc">Waktu Pembuatan (Terbaru)</option>
                                <option value="created-asc">Waktu Pembuatan (Terlama)</option>
                                <option value="amount-desc">Jumlah Terbesar</option>
                                <option value="amount-asc">Jumlah Terkecil</option>
                                <!--
                                <option value="keterangan-asc">Keterangan A-Z</option>
                                <option value="keterangan-desc">Keterangan Z-A</option>
                                 -->
                            </select>
                        </div>
                    </div>
                    <div id="transactionsTable">
                        <!-- Table or empty state for transactions will be rendered here by JavaScript -->
                    </div>
                    <div id="transactionSummary" class="transaction-summary">
                        <div id="summaryIncome" class="summary-income">Total Pemasukan (Filter): Rp 0</div>
                        <div id="summaryExpense" class="summary-expense">Total Pengeluaran (Filter): Rp 0</div>
                    </div>
                    <div id="paginationControls" class="pagination-controls">
                        <!-- Pagination buttons will be rendered here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="addDoctorModal" class="modal">
        <div class="modal-content">
            <h3><i data-feather="user-plus"></i>Tambah Dokter Baru</h3>
            <div class="form-group">
                <label for="newDoctorName">Nama Lengkap Dokter</label>
                <input type="text" id="newDoctorName" placeholder="Contoh: Dr. Ayu Lestari" oninput="checkDoctorName()">
                <small id="nameHint" style="font-size: 0.8rem; display: none; margin-top: 5px;"></small>
            </div>
            <div class="form-group">
                <label for="initialDeposit">Deposit Awal (Opsional)</label>
                <div class="input-with-icon">
                    <input type="text" id="initialDeposit" placeholder="Contoh: 500.000"
                        oninput="formatAmountInput(this)">
                    <i data-feather="grid" class="calculator-trigger-icon"
                        onclick="showCalculatorModal('initialDeposit')"></i>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-outline" onclick="closeModal('addDoctorModal')">Batal</button>
                <button class="btn btn-primary" onclick="addDoctor()">Simpan Dokter</button>
            </div>
        </div>
    </div>

    <div id="addDepositModal" class="modal">
        <div class="modal-content">
            <h3><i data-feather="dollar-sign"></i>Tambah Dana Deposit</h3>
            <div class="form-group">
                <label for="depositDesc">Keterangan Deposit</label>
                <input type="text" id="depositDesc" placeholder="Contoh: Deposit rutin bulanan">
            </div>
            <div class="form-group">
                <label for="additionalDeposit">Jumlah Deposit (Rp)</label>
                <div class="input-with-icon">
                    <input type="text" id="additionalDeposit" placeholder="Contoh: 200.000"
                        oninput="formatAmountInput(this)">
                    <i data-feather="grid" class="calculator-trigger-icon"
                        onclick="showCalculatorModal('additionalDeposit')"></i>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-outline" onclick="closeModal('addDepositModal')">Batal</button>
                <button class="btn btn-success" onclick="addDeposit()">Tambah Deposit</button>
            </div>
        </div>
    </div>

    <!-- Add Expense Modal -->
    <div id="addExpenseModal" class="modal">
        <div class="modal-content">
            <h3><i data-feather="minus-circle"></i>Tambah Pengeluaran Baru</h3>
            <form id="addExpenseForm">
                <div class="form-group">
                    <label for="expenseDateModal">Tanggal Pengeluaran</label>
                    <input type="date" id="expenseDateModal" required>
                </div>
                <div class="form-group">
                    <label for="expenseDescModal">Keterangan</label>
                    <input type="text" id="expenseDescModal" placeholder="Contoh: Pembelian alat tulis" required>
                </div>
                <div class="form-group">
                    <label for="expenseAmountModal">Nominal (Rp)</label>
                    <div class="input-with-icon">
                        <input type="text" id="expenseAmountModal" placeholder="Contoh: 50.000" required
                            oninput="formatAmountInput(this)">
                        <i data-feather="grid" class="calculator-trigger-icon"
                            onclick="showCalculatorModal('expenseAmountModal')"></i>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-outline" onclick="closeModal('addExpenseModal')">Batal</button>
                    <button type="submit" class="btn btn-primary">
                        <i data-feather="plus"></i> Simpan Pengeluaran
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div id="editTransactionModal" class="modal">
        <div class="modal-content">
            <h3><i data-feather="edit"></i>Edit Transaksi</h3>
            <form id="editTransactionForm">
                <input type="hidden" id="editTransactionId">
                <div class="form-group">
                    <label for="editTransactionType">Jenis Transaksi</label>
                    <select id="editTransactionType" class="form-group input" disabled>
                        <option value="expense">Pengeluaran</option>
                        <option value="income">Pemasukan</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editTransactionDate">Tanggal</label>
                    <input type="date" id="editTransactionDate" required>
                </div>
                <div class="form-group">
                    <label for="editTransactionDesc">Keterangan</label>
                    <input type="text" id="editTransactionDesc" required>
                </div>
                <div class="form-group">
                    <label for="editTransactionAmount">Nominal (Rp)</label>
                    <div class="input-with-icon">
                        <input type="text" id="editTransactionAmount" required oninput="formatAmountInput(this)">
                        <i data-feather="grid" class="calculator-trigger-icon"
                            onclick="showCalculatorModal('editTransactionAmount')"></i>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-outline"
                        onclick="closeModal('editTransactionModal')">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirmDeleteModal" class="modal">
        <div class="modal-content">
            <h3><i data-feather="alert-triangle" style="color: var(--red);"></i>Konfirmasi Hapus Transaksi</h3>
            <p>Anda yakin ingin menghapus transaksi ini secara permanen? Tindakan ini tidak dapat diurungkan.</p>
            <div class="modal-buttons">
                <button class="btn btn-outline" onclick="closeModal('confirmDeleteModal')">Batal</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Ya, Hapus Transaksi</button>
            </div>
        </div>
    </div>

    <div id="confirmDeleteDoctorModal" class="modal">
        <div class="modal-content">
            <h3><i data-feather="alert-triangle" style="color: var(--red);"></i>Konfirmasi Hapus Dokter</h3>
            <p id="deleteDoctorText">Yakin ingin menghapus dokter ini beserta semua data transaksinya? Tindakan ini
                tidak dapat diurungkan.</p>
            <div class="modal-buttons">
                <button class="btn btn-outline" onclick="closeModal('confirmDeleteDoctorModal')">Batal</button>
                <button class="btn btn-danger" onclick="confirmDeleteDoctor()">Ya, Hapus Dokter</button>
            </div>
        </div>
    </div>

    <div id="exportPDFModal" class="modal">
        <div class="modal-content">
            <h3><i data-feather="settings"></i>Pengaturan Export Laporan PDF</h3>
            <div class="form-group">
                <label for="exportType">Pilih Data untuk Diexport:</label>
                <select id="exportType" class="form-group input"> <!-- Ensure class is applied -->
                    <option value="all">Semua Transaksi</option>
                    <option value="range">Transaksi Berdasarkan Tanggal</option>
                </select>
            </div>
            <div id="dateRangeGroup" style="display: none;">
                <div class="form-group">
                    <label for="exportFromDate">Dari Tanggal:</label>
                    <input type="date" id="exportFromDate" class="form-group input">
                </div>
                <div class="form-group">
                    <label for="exportToDate">Sampai Tanggal:</label>
                    <input type="date" id="exportToDate" class="form-group input">
                </div>
            </div>
            <div class="form-group">
                <label for="exportSort">Urutkan Berdasarkan:</label>
                <select id="exportSort" class="form-group input">
                    <option value="newest">Transaksi Terbaru Dulu</option>
                    <option value="oldest">Transaksi Terlama Dulu</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-outline" onclick="closeModal('exportPDFModal')">Batal</button>
                <button class="btn btn-primary" onclick="processExportToPDF()">
                    <i data-feather="download"></i> Export ke PDF
                </button>
            </div>
        </div>
    </div>

    <!-- Calculator Modal -->
    <div id="calculatorModal" class="modal">
        <div class="modal-content calculator-content">
            <h3><i data-feather="calculator"></i> Kalkulator</h3>
            <div class="calculator-display-container">
                <input type="text" id="calculatorDisplay" readonly>
            </div>
            <div class="calculator-buttons">
                <button onclick="appendToCalculatorDisplay('7')">7</button>
                <button onclick="appendToCalculatorDisplay('8')">8</button>
                <button onclick="appendToCalculatorDisplay('9')">9</button>
                <button class="operator" onclick="appendToCalculatorDisplay('/')">÷</button>

                <button onclick="appendToCalculatorDisplay('4')">4</button>
                <button onclick="appendToCalculatorDisplay('5')">5</button>
                <button onclick="appendToCalculatorDisplay('6')">6</button>
                <button class="operator" onclick="appendToCalculatorDisplay('*')">×</button>

                <button onclick="appendToCalculatorDisplay('1')">1</button>
                <button onclick="appendToCalculatorDisplay('2')">2</button>
                <button onclick="appendToCalculatorDisplay('3')">3</button>
                <button class="operator" onclick="appendToCalculatorDisplay('-')">−</button>

                <button onclick="appendToCalculatorDisplay('0')">0</button>
                <button onclick="appendToCalculatorDisplay('.')">.</button>
                <button class="operator danger" onclick="clearCalculatorDisplay()">C</button>
                <button class="operator" onclick="appendToCalculatorDisplay('+')">+</button>

                <button class="span-2" onclick="calculateResult()">=</button>
                <button class="span-2 primary" onclick="applyCalculatorResult()">OK</button>
            </div>
            <div class="modal-buttons" style="margin-top: 15px;">
                <button type="button" class="btn btn-outline" style="width:100%"
                    onclick="closeModal('calculatorModal')">Tutup Kalkulator</button>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notification" class="notification"></div>

    <!-- Connection Status Indicator -->
    <div id="connectionStatus" class="connection-status online">
        <i data-feather="wifi" style="width: 16px; height: 16px;"></i>
        <span id="statusText">Online</span>
    </div>

    <script>
        // ===================================================================================
        // JAVASCRIPT LOGIC
        // ===================================================================================

        // ===== FIREBASE CONFIGURATION =====
        let firebaseAvailable = false;
        let auth, db;
        // Flag to ensure initial auto-sign-in logic runs only once
        let initialAuthAttempted = false;


        function initializeFirebase() {
            if (typeof firebase !== 'undefined') {
                console.log('✅ Firebase SDK loaded successfully');
                firebaseAvailable = true;

                let effectiveFirebaseConfig;

                // Try to use Canvas-provided config first
                if (typeof __firebase_config !== 'undefined' && __firebase_config.trim() !== "" && __firebase_config !== "YOUR_FIREBASE_CONFIG_JSON_STRING") {
                    try {
                        effectiveFirebaseConfig = JSON.parse(__firebase_config);
                        console.log('🔧 Using Firebase config provided by Canvas environment.');
                    } catch (e) {
                        console.error('Error parsing __firebase_config. Falling back to manual config.', e);
                        // Fallback to user's hardcoded config if __firebase_config is malformed
                        effectiveFirebaseConfig = {
                            apiKey: "AIzaSyCDDmHhlwcjgBArmvXiaTnjgKqGHIi3DHc",
                            authDomain: "wmproject-9269a.firebaseapp.com",
                            projectId: "wmproject-9269a",
                            storageBucket: "wmproject-9269a.firebasestorage.app",
                            messagingSenderId: "706043186227",
                            appId: "1:706043186227:web:470bfa89aa78c68829e746",
                            measurementId: "G-FW9JLPDVJS"
                        };
                        console.warn('🔧 Using manual Firebase config as fallback due to __firebase_config parse error.');
                    }
                } else {
                    // Fallback to user's hardcoded config if __firebase_config is not defined or is placeholder
                    effectiveFirebaseConfig = {
                        apiKey: "AIzaSyCDDmHhlwcjgBArmvXiaTnjgKqGHIi3DHc",
                        authDomain: "wmproject-9269a.firebaseapp.com",
                        projectId: "wmproject-9269a",
                        storageBucket: "wmproject-9269a.firebasestorage.app",
                        messagingSenderId: "706043186227",
                        appId: "1:706043186227:web:470bfa89aa78c68829e746",
                        measurementId: "G-FW9JLPDVJS"
                    };
                    if (typeof __firebase_config === 'undefined') {
                        console.warn('🔧 __firebase_config not found. Using manual Firebase config placeholders. Please replace them with your actual Firebase project details.');
                    } else {
                        console.warn('🔧 __firebase_config seems to be a placeholder. Using manual Firebase config placeholders. Please replace them with your actual Firebase project details.');
                    }
                }


                try {
                    // Check if Firebase app already initialized to prevent re-initialization error
                    if (!firebase.apps.length) {
                        firebase.initializeApp(effectiveFirebaseConfig);
                    } else {
                        firebase.app(); // if already initialized, use that one
                    }
                    auth = firebase.auth();
                    db = firebase.firestore();
                    // Attempt to enable persistence, log errors if any.
                    db.enablePersistence({ synchronizeTabs: true }) // synchronizeTabs can help in multi-tab scenarios
                        .then(() => console.log("Offline persistence enabled."))
                        .catch((err) => {
                            if (err.code == 'failed-precondition') {
                                console.warn('Offline persistence failed: Multiple tabs open or other issues. Persistence can only be enabled in one tab at a time.');
                            } else if (err.code == 'unimplemented') {
                                console.warn('Offline persistence failed: The current browser does not support all of the features required to enable persistence.');
                            } else {
                                console.warn('Offline persistence error:', err.code, err.message);
                            }
                        });
                    console.log('🔥 Firebase initialized successfully with project ID:', effectiveFirebaseConfig.projectId);
                } catch (error) {
                    console.error('Firebase initialization error:', error);
                    firebaseAvailable = false;
                }
            } else {
                console.log('⚠️ Firebase SDK not available, using development mode');
                firebaseAvailable = false;
            }
        }

        // ===== GLOBAL VARIABLES =====
        let currentUser = null;
        let doctors = [];
        let currentDoctorId = null;
        let deleteTransactionId = null;
        let currentEditingTransactionId = null; // For editing transactions
        let isOnline = navigator.onLine;
        let currentTransactionPage = 1;
        const transactionsPerPage = 7; // Updated to 7
        let calculatorTargetInputId = null; // To store the ID of the input field for the calculator
        let currentFilteredTransactions = []; // Store all filtered transactions before pagination
        let currentSortOrder = 'created-desc'; // Default sort order as requested


        // ===== CONNECTION STATUS UI =====
        function updateConnectionStatus() {
            const statusEl = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            const statusIcon = statusEl.querySelector('i');

            if (!navigator.onLine) {
                statusEl.className = 'connection-status offline';
                statusText.textContent = 'Offline';
                isOnline = false;
                if (statusIcon) statusIcon.setAttribute('data-feather', 'wifi-off');
            } else {
                statusEl.className = 'connection-status online';
                statusText.textContent = 'Online';
                isOnline = true;
                if (statusIcon) statusIcon.setAttribute('data-feather', 'wifi');
            }
            if (typeof feather !== 'undefined') feather.replace();
        }

        function showSyncStatus() {
            const statusEl = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            const statusIcon = statusEl.querySelector('i');

            statusEl.className = 'connection-status syncing';
            statusText.textContent = 'Sinkronisasi...';
            if (statusIcon) statusIcon.setAttribute('data-feather', 'refresh-cw');
            if (typeof feather !== 'undefined') feather.replace();

            setTimeout(() => {
                updateConnectionStatus();
            }, 2000);
        }

        window.addEventListener('online', updateConnectionStatus);
        window.addEventListener('offline', updateConnectionStatus);

        // ===== AUTHENTICATION LOGIC =====
        async function initAuth() {
            if (!firebaseAvailable || !auth) {
                console.warn("Firebase auth is not available. Bypassing to dev mode.");
                bypassLoginForDevelopment();
                hideLoadingScreen();
                return;
            }

            const currentApiKey = auth.app.options.apiKey;
            // Check if using placeholder and no Canvas config
            if (currentApiKey === "YOUR_API_KEY" && typeof __firebase_config === 'undefined') {
                console.warn("Firebase using hardcoded placeholder API key and no Canvas config. Ensure your Firebase config is correct if not using Canvas environment variables. Bypassing to dev mode.");
                bypassLoginForDevelopment();
                hideLoadingScreen();
                return;
            }


            auth.onAuthStateChanged(async (user) => {
                console.log('Auth state changed. User:', user ? user.uid : null, 'Is Anonymous:', user ? user.isAnonymous : 'N/A');

                if (user) {
                    currentUser = user;
                    initialAuthAttempted = true;
                    showMainApp();
                    await loadUserData();
                    hideLoadingScreen();
                } else {
                    if (!initialAuthAttempted) {
                        initialAuthAttempted = true;
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token && __initial_auth_token.trim() !== "") {
                                console.log('Attempting sign-in with custom token...');
                                await auth.signInWithCustomToken(__initial_auth_token);
                                console.log('Custom token sign-in initiated. onAuthStateChanged will handle the new user state.');
                            } else {
                                console.log('No custom token, or Canvas environment not providing one. Attempting anonymous sign-in...');
                                await auth.signInAnonymously();
                                console.log('Anonymous sign-in initiated. onAuthStateChanged will handle the new user state.');
                            }
                        } catch (error) {
                            console.error('Error during initial auto-sign-in (custom/anonymous):', error);
                            let specificErrorMsg = 'Gagal memulai sesi otomatis. Beberapa fitur mungkin tidak berfungsi normal.';
                            if (error.code === 'auth/custom-token-mismatch') {
                                specificErrorMsg = 'Gagal memulai sesi: Token tidak cocok dengan proyek Firebase. Pastikan konfigurasi Firebase (apiKey, projectId, dll.) sesuai dengan token yang digunakan.';
                                console.warn('Custom token audience (project) might not match the Firebase project initialized by the SDK. Effective project ID:', auth.app.options.projectId);
                            } else if (error.code === 'auth/invalid-custom-token') {
                                specificErrorMsg = 'Gagal memulai sesi: Format token kustom tidak valid.';
                            }
                            showNotification(specificErrorMsg, 'error');
                            currentUser = null;
                            showLoginScreen();
                            hideLoadingScreen();
                        }
                    } else {
                        console.log('User signed out or no user after initial auth attempts.');
                        currentUser = null;
                        showLoginScreen();
                        hideLoadingScreen();
                    }
                }
            });
        }

        function bypassLoginForDevelopment() {
            console.log('🔧 DEVELOPMENT MODE: Bypassing Firebase login');
            currentUser = {
                uid: 'dev-user-123',
                email: 'developer@example.com',
                displayName: 'Developer Mode',
                photoURL: `https://ui-avatars.com/api/?name=Dev&background=4f46e5&color=fff&bold=true`
            };
            doctors = [];
            showMainApp();
            populateDoctorDropdown();
            selectDoctor(null);
            showNotification('🔧 Mode Development Aktif. Data tidak disimpan ke Firebase.', 'info');
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        }

        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'flex';
            if (currentUser) {
                document.getElementById('userAvatar').src = currentUser.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.displayName || currentUser.email || 'User')}&background=e2e8f0&color=1e293b&bold=true`;
                document.getElementById('userAvatar').alt = currentUser.displayName || currentUser.email || 'User Avatar';
            }
        }

        function hideLoadingScreen() {
            document.getElementById('loadingScreen').style.display = 'none';
        }

        async function signInWithGoogle() {
            if (!firebaseAvailable || !auth) {
                showNotification('❌ Konfigurasi Firebase tidak ditemukan.', 'error');
                return;
            }
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await auth.signInWithPopup(provider);
                showNotification(`✅ Login Google berhasil! Selamat datang, ${result.user.displayName || result.user.email}!`, 'success');
            } catch (error) {
                console.error('Google Login error:', error);
                if (error.code === 'auth/operation-not-supported-in-this-environment') {
                    showNotification('❌ Login Google via popup tidak didukung di lingkungan ini. Coba buka aplikasi di tab browser biasa atau pastikan web storage aktif.', 'error');
                } else if (error.code === 'auth/popup-closed-by-user') {
                    showNotification('ℹ️ Proses login Google dibatalkan oleh pengguna.', 'info');
                } else if (error.code === 'auth/cancelled-popup-request') {
                    showNotification('ℹ️ Permintaan login Google sebelumnya masih aktif atau dibatalkan. Silakan coba lagi.', 'info');
                }
                else {
                    showNotification('❌ Login Google gagal: ' + error.message, 'error');
                }
            }
        }

        async function signOut() {
            if (!firebaseAvailable || !auth || (currentUser && currentUser.uid === 'dev-user-123')) {
                currentUser = null;
                initialAuthAttempted = false; // Reset flag to allow re-auth attempt on next load if applicable
                showLoginScreen();
                showNotification('ℹ️ Anda telah keluar dari mode development.', 'info');
                // Reset app state
                doctors = [];
                currentDoctorId = null;
                populateDoctorDropdown();
                selectDoctor(null); // This will ensure UI is reset for no doctor
                return;
            }
            try {
                await auth.signOut();
                showNotification('ℹ️ Anda telah berhasil keluar.', 'info');
                currentDoctorId = null;
                doctors = [];
                populateDoctorDropdown();
                selectDoctor(null);
                initialAuthAttempted = false; // Allow re-auth (e.g. anonymous) on next load if needed
            } catch (error) {
                showNotification('❌ Gagal keluar: ' + error.message, 'error');
            }
        }

        // ===== FIRESTORE DATA OPERATIONS =====
        async function loadUserData() {
            if (!currentUser || !currentUser.uid) {
                console.warn("loadUserData called but currentUser or currentUser.uid is not available. Current user:", currentUser);
                selectDoctor(null); // Ensure UI reflects no user/no data state
                return;
            }
            if (!firebaseAvailable && currentUser.uid === 'dev-user-123') {
                console.log('🔧 Dev mode: Using in-memory data for doctors.');
                populateDoctorDropdown();
                if (doctors.length > 0) {
                    selectDoctor(doctors[0].id);
                } else {
                    selectDoctor(null);
                }
                return;
            }

            if (!db) {
                console.error("Firestore database instance (db) is not available.");
                showNotification("❌ Database tidak tersedia. Tidak dapat memuat data.", "error");
                selectDoctor(null); // Reflect error state in UI
                return;
            }

            try {
                showSyncStatus();
                console.log(`Attempting to load data for UID: ${currentUser.uid}, Is Anonymous: ${currentUser.isAnonymous}. Project ID: ${auth.app.options.projectId}`);
                const userDocRef = db.collection('users').doc(currentUser.uid);
                const docSnapshot = await userDocRef.get();
                if (docSnapshot.exists) {
                    const data = docSnapshot.data();
                    doctors = Array.isArray(data.doctors) ? data.doctors : [];
                    // Ensure each doctor has a transactions array
                    doctors.forEach(doc => {
                        if (!Array.isArray(doc.transactions)) {
                            doc.transactions = [];
                        }
                        // Ensure createdAt exists for sorting, default if missing
                        doc.transactions.forEach(t => {
                            if (!t.createdAt) {
                                // If createdAt is missing, try to use 'date' or a very old date for older items
                                // For new items, it's set on creation.
                                // This fallback is for potentially old data that didn't have createdAt.
                                t.createdAt = t.date || '1970-01-01T00:00:00.000Z';
                            }
                        });
                    });
                    console.log(`Data loaded for UID: ${currentUser.uid}. Number of doctors: ${doctors.length}`);
                } else {
                    doctors = [];
                    console.log(`No data found for UID: ${currentUser.uid}. Initializing with empty doctors list.`);
                    if (!currentUser.isAnonymous) {
                        showNotification('🎉 Selamat datang! Silakan tambahkan dokter pertama Anda.', 'success');
                    } else {
                        console.log("New anonymous session, no existing data to load, this is expected.");
                    }
                }
                populateDoctorDropdown();
                if (doctors.length > 0) {
                    const currentDoctorStillExists = doctors.some(d => d.id === currentDoctorId);
                    if (!currentDoctorId || !currentDoctorStillExists) {
                        // Try to restore last selected doctor, or default to first
                        const lastSelectedDoctorId = localStorage.getItem(`lastSelectedDoctor_${currentUser.uid}`);
                        if (lastSelectedDoctorId && doctors.some(d => d.id == lastSelectedDoctorId)) {
                            selectDoctor(lastSelectedDoctorId);
                        } else {
                            selectDoctor(doctors[0].id);
                        }
                    } else {
                        selectDoctor(currentDoctorId);
                    }
                } else {
                    selectDoctor(null);
                }
            } catch (error) {
                console.error(`Error loading user data from Firestore for UID: ${currentUser.uid} on Project ID: ${auth.app.options.projectId}:`, error);
                let errorMsg = '❌ Gagal memuat data pengguna dari cloud.';
                if (error.code === 'permission-denied' || (error.message && error.message.toLowerCase().includes("missing or insufficient permissions"))) {
                    errorMsg = `❌ Gagal memuat data: Izin ditolak untuk UID ${currentUser.uid} pada proyek ${auth.app.options.projectId}. Pastikan aturan keamanan Firestore Anda mengizinkan akses.`;
                    console.error("Firestore permission error details:", error.details || "No details provided by Firebase error object.");
                } else {
                    errorMsg += ` (${error.message || error.code || 'Unknown error'})`;
                }
                showNotification(errorMsg, 'error');
                doctors = []; // Reset doctors on error
                populateDoctorDropdown();
                selectDoctor(null); // Ensure UI reflects error state
            }
        }

        async function saveUserData() {
            if (!currentUser || !currentUser.uid) {
                console.warn("saveUserData called but currentUser or currentUser.uid is not available. Current user:", currentUser);
                showNotification("Tidak dapat menyimpan data: Sesi pengguna tidak valid.", "error");
                return;
            }
            if (!firebaseAvailable && currentUser.uid === 'dev-user-123') {
                console.log('🔧 Dev mode or no user: Skipping Firebase save.');
                // For dev mode, we might want to simulate save or log current state
                console.log('Current doctors (dev mode):', JSON.parse(JSON.stringify(doctors)));
                return;
            }
            if (!db) {
                console.error("Firestore database instance (db) is not available for saving.");
                showNotification("❌ Database tidak tersedia. Tidak dapat menyimpan data.", "error");
                return;
            }
            try {
                showSyncStatus();
                console.log(`Attempting to save data for UID: ${currentUser.uid} on Project ID: ${auth.app.options.projectId}`);
                const userDocRef = db.collection('users').doc(currentUser.uid);
                const now = new Date().toISOString();
                // Ensure transactions are arrays
                const doctorsToSave = doctors.map(doc => ({
                    ...doc,
                    transactions: Array.isArray(doc.transactions) ? doc.transactions : [],
                    updatedAt: now,
                    createdAt: doc.createdAt || now
                }));

                await userDocRef.set({ doctors: doctorsToSave, lastUpdated: now }, { merge: true });
                console.log('Data saved successfully to Firebase.');
            } catch (error) {
                console.error(`Error saving data to Firestore for UID: ${currentUser.uid} on Project ID: ${auth.app.options.projectId}:`, error);
                let errorMsg = '⚠️ Gagal menyimpan data ke cloud.';
                if (error.code === 'permission-denied' || (error.message && error.message.toLowerCase().includes("missing or insufficient permissions"))) {
                    errorMsg = `❌ Gagal menyimpan data: Izin ditolak untuk UID ${currentUser.uid} pada proyek ${auth.app.options.projectId}. Pastikan aturan keamanan Firestore Anda mengizinkan penulisan.`;
                } else {
                    errorMsg += ` (${error.message || error.code || 'Unknown error'})`;
                }
                showNotification(errorMsg, 'error');
            }
        }

        // ===== UI UTILITY FUNCTIONS =====
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification ' + type;
            notification.classList.add('show');
            setTimeout(() => { notification.classList.remove('show'); }, 5000);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(amount);
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('id-ID').format(num);
        }

        function unformatNumber(str) {
            return parseInt(String(str).replace(/\./g, '').replace(/,/g, '')) || 0;
        }

        function formatAmountInput(inputElement) {
            let value = inputElement.value;
            let unformattedValue = value.replace(/\D/g, '');

            if (unformattedValue) {
                let numberValue = parseInt(unformattedValue, 10);
                inputElement.value = formatNumber(numberValue);
            } else {
                inputElement.value = '';
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                // Check if the date is valid after parsing
                if (isNaN(date.getTime())) {
                    // Try to parse as YYYY-MM-DD if it failed (common for date inputs)
                    const parts = dateString.split('-');
                    if (parts.length === 3) {
                        const year = parseInt(parts[0], 10);
                        const month = parseInt(parts[1], 10) - 1; // Month is 0-indexed
                        const day = parseInt(parts[2], 10);
                        const constructedDate = new Date(year, month, day);
                        if (!isNaN(constructedDate.getTime())) {
                            return constructedDate.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
                        }
                    }
                    console.warn("Invalid date string provided:", dateString);
                    return dateString; // Return original if parsing fails
                }
                return date.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
            } catch (e) {
                console.warn("Error formatting date:", dateString, e);
                return dateString; // Return original on error
            }
        }


        function setTodayDate(elementId) {
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById(elementId);
            if (dateInput) dateInput.value = today;
        }

        // ===== DOCTOR MANAGEMENT (Adapted for Dropdown UI) =====
        function populateDoctorDropdown(searchTerm = '') {
            const listElement = document.getElementById('doctorList');
            listElement.innerHTML = ''; // Clear previous items

            const filteredDoctors = doctors.filter(doc =>
                doc.name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            if (filteredDoctors.length === 0) {
                listElement.innerHTML = `
                    <li class="doctor-list-empty-state">
                        <span>${searchTerm ? 'Dokter tidak ditemukan.' : (doctors.length === 0 ? 'Belum ada dokter.' : 'Tidak ada dokter yang cocok.')}</span>
                    </li>`;
            } else {
                filteredDoctors.forEach(doctor => {
                    const li = document.createElement('li');
                    li.setAttribute('data-id', doctor.id);
                    li.textContent = doctor.name;
                    if (doctor.id == currentDoctorId) { // Use == for type coercion if IDs might be numbers/strings
                        li.classList.add('active-selection');
                    }
                    li.onclick = () => {
                        selectDoctor(doctor.id);
                        closeDoctorDropdown();
                        closeDrawer(); // Close sidebar/drawer after selecting a doctor
                    }
                    listElement.appendChild(li);
                });
            }
            // Feather icons replacement might not be needed here unless icons are added to list items
        }


        function toggleDoctorDropdown() {
            const wrapper = document.getElementById('dokterDropdownListWrapper');
            const activeEl = document.getElementById('dokterDropdownActive');
            wrapper.classList.toggle('open');
            activeEl.classList.toggle('open');
            if (wrapper.classList.contains('open')) {
                document.getElementById('dokterSearchInput').focus();
                populateDoctorDropdown();
            }
        }

        function closeDoctorDropdown() {
            document.getElementById('dokterDropdownListWrapper').classList.remove('open');
            document.getElementById('dokterDropdownActive').classList.remove('open');
        }

        // UPDATED selectDoctor function
        function selectDoctor(doctorId) {
            currentDoctorId = doctorId; // Can be null
            currentTransactionPage = 1; // Reset pagination
            // currentSortOrder = 'date-desc'; // Reset sort order to default or maintain current? Let's maintain.
            const sortTransaksiSelect = document.getElementById('sortTransaksi');
            if (sortTransaksiSelect) sortTransaksiSelect.value = currentSortOrder;


            const doctor = doctors.find(d => d.id == doctorId); // doctor will be undefined if doctorId is null or not found

            const deleteDoctorButton = document.getElementById('deleteDoctorBtn');
            const activeDokterNameEl = document.getElementById('activeDokterName');
            const doctorInfoSection = document.getElementById('doctorInfo');
            const noDoctorSelectedSection = document.getElementById('noDoctorSelected');
            const welcomeHeader = document.getElementById('welcomeHeader');
            const welcomeSubheader = document.getElementById('welcomeSubheader');

            // Reset transaction filters regardless of whether a doctor is selected or not
            document.getElementById('searchKeterangan').value = '';
            document.getElementById('filterTanggalMulai').value = '';
            document.getElementById('filterTanggalAkhir').value = '';
            document.getElementById('filterJenisTransaksi').value = 'semua';
            const filterSection = document.getElementById('transactionFilters');
            const toggleFilterButton = document.getElementById('toggleFilterBtn');
            filterSection.classList.remove('open'); // Close filter section
            toggleFilterButton.innerHTML = '<i data-feather="filter"></i> <span>Tampilkan Filter</span>';


            if (doctor) { // A valid doctor is selected
                activeDokterNameEl.textContent = doctor.name;
                welcomeHeader.textContent = `Catatan ${doctor.name}`;
                welcomeSubheader.textContent = `Kelola data keuangan untuk ${doctor.name}.`;

                updateDoctorInfoUI(doctor); // This will calculate overall stats and then call applyTransactionFiltersAndRender

                doctorInfoSection.style.display = 'block';
                noDoctorSelectedSection.style.display = 'none';
                if (deleteDoctorButton) deleteDoctorButton.style.display = 'inline-flex';
                setTodayDate('expenseDateModal'); // Set default date for new expense

                // Save last selected doctor to localStorage
                if (currentUser && currentUser.uid) {
                    localStorage.setItem(`lastSelectedDoctor_${currentUser.uid}`, doctor.id);
                }

            } else { // No doctor selected (doctorId is null or doctor not found)
                activeDokterNameEl.textContent = 'Pilih Dokter...';
                currentDoctorId = null; // Ensure it's explicitly null if doctor not found

                updateDoctorInfoUI(null); // Call with null to reset stats and transaction UI

                doctorInfoSection.style.display = 'none';
                noDoctorSelectedSection.style.display = 'block';
                welcomeHeader.textContent = 'Dasbor Utama';
                welcomeSubheader.textContent = 'Selamat datang! Pilih dokter untuk memulai.';
                if (deleteDoctorButton) deleteDoctorButton.style.display = 'none';

                // Clear last selected doctor from localStorage if no doctor is active
                if (currentUser && currentUser.uid) {
                    localStorage.removeItem(`lastSelectedDoctor_${currentUser.uid}`);
                }
            }
            if (typeof feather !== 'undefined') feather.replace(); // Update icons
        }


        // UPDATED updateDoctorInfoUI function
        function updateDoctorInfoUI(doctor) {
            const totalDepositEl = document.getElementById('totalDeposit');
            const totalExpenseEl = document.getElementById('totalExpense');
            const remainingBalanceEl = document.getElementById('remainingBalance');

            if (!doctor || !doctor.id) { // Handles null or invalid doctor object
                console.warn("updateDoctorInfoUI: No valid doctor selected or passed. Resetting stats.");
                totalDepositEl.textContent = formatCurrency(0);
                totalExpenseEl.textContent = formatCurrency(0);
                remainingBalanceEl.textContent = formatCurrency(0);
                remainingBalanceEl.className = 'stat-card-value positive'; // Default class

                currentFilteredTransactions = [];
                renderTransactions([], 1);      // Render empty transaction table
                updateTransactionSummary([]);   // Reset filtered summary (which should also be 0)
                return;
            }

            // Ensure doctor.transactions is an array, default to empty if not
            const transactions = Array.isArray(doctor.transactions) ? doctor.transactions : [];

            const totalIncomeOverall = transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + (Number(t.amount) || 0), 0); // Ensure amount is treated as number

            const totalExpenseOverall = transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + (Number(t.amount) || 0), 0); // Ensure amount is treated as number

            const remainingBalanceOverall = totalIncomeOverall - totalExpenseOverall;

            totalDepositEl.textContent = formatCurrency(totalIncomeOverall);
            totalExpenseEl.textContent = formatCurrency(totalExpenseOverall);
            remainingBalanceEl.textContent = formatCurrency(remainingBalanceOverall);
            remainingBalanceEl.className = 'stat-card-value'; // Reset classes first
            remainingBalanceEl.classList.add(remainingBalanceOverall < 0 ? 'negative' : 'positive');

            // This will handle filtering and rendering the transaction table based on the current doctor's full transaction list.
            applyTransactionFiltersAndRender();
        }


        // ===== TRANSACTIONS FILTERING, SORTING AND RENDERING =====
        function applyTransactionFiltersAndRender() {
            const doctor = doctors.find(d => d.id == currentDoctorId); // Get the current doctor again

            if (!doctor || !Array.isArray(doctor.transactions)) { // Guard against no doctor or no transactions array
                currentFilteredTransactions = [];
                renderTransactions([], 1);
                updateTransactionSummary([]);
                return;
            }

            let transactionsToDisplay = doctor.transactions.slice(); // Start with all transactions for the current doctor

            // Apply search filter (Keterangan)
            const searchTerm = document.getElementById('searchKeterangan').value.toLowerCase();
            if (searchTerm) {
                transactionsToDisplay = transactionsToDisplay.filter(t =>
                    (t.description || '').toLowerCase().includes(searchTerm)
                );
            }

            // Apply date range filter
            const startDateStr = document.getElementById('filterTanggalMulai').value;
            const endDateStr = document.getElementById('filterTanggalAkhir').value;
            if (startDateStr) {
                const startDate = new Date(startDateStr);
                startDate.setHours(0, 0, 0, 0); // Set to start of the day
                transactionsToDisplay = transactionsToDisplay.filter(t => new Date(t.date) >= startDate);
            }
            if (endDateStr) {
                const endDate = new Date(endDateStr);
                endDate.setHours(23, 59, 59, 999); // Set to end of the day
                transactionsToDisplay = transactionsToDisplay.filter(t => new Date(t.date) <= endDate);
            }

            // Apply type filter (Jenis Transaksi)
            const typeFilter = document.getElementById('filterJenisTransaksi').value;
            if (typeFilter !== 'semua') {
                transactionsToDisplay = transactionsToDisplay.filter(t => t.type === typeFilter);
            }

            // Apply sorting based on currentSortOrder
            transactionsToDisplay.sort((a, b) => {
                let comparison = 0;
                // Ensure createdAt is a valid date or fallback for comparison
                const createdAtA = a.createdAt ? new Date(a.createdAt) : new Date(0); // Fallback to epoch if undefined
                const createdAtB = b.createdAt ? new Date(b.createdAt) : new Date(0); // Fallback to epoch if undefined

                if (currentSortOrder === 'date-desc') {
                    comparison = new Date(b.date) - new Date(a.date);
                    if (comparison === 0) { // If dates are the same, sort by createdAt descending (newest first)
                        comparison = createdAtB - createdAtA;
                    }
                } else if (currentSortOrder === 'date-asc') {
                    comparison = new Date(a.date) - new Date(b.date);
                    if (comparison === 0) { // If dates are the same, sort by createdAt ascending (oldest first)
                        comparison = createdAtA - createdAtB;
                    }
                } else if (currentSortOrder === 'created-asc') { // FIFO
                    comparison = createdAtA - createdAtB;
                } else if (currentSortOrder === 'created-desc') { // LIFO
                    comparison = createdAtB - createdAtA;
                } else if (currentSortOrder === 'amount-asc') {
                    comparison = (Number(a.amount) || 0) - (Number(b.amount) || 0);
                } else if (currentSortOrder === 'amount-desc') {
                    comparison = (Number(b.amount) || 0) - (Number(a.amount) || 0);
                } else if (currentSortOrder === 'keterangan-asc') {
                    comparison = (a.description || '').localeCompare(b.description || '', undefined, { sensitivity: 'base' });
                } else if (currentSortOrder === 'keterangan-desc') {
                    comparison = (b.description || '').localeCompare(a.description || '', undefined, { sensitivity: 'base' });
                }
                return comparison;
            });


            currentFilteredTransactions = transactionsToDisplay; // Store the filtered and sorted list
            updateTransactionSummary(currentFilteredTransactions); // Update summary totals based on this list
            renderTransactions(currentFilteredTransactions, currentTransactionPage); // Render the paginated table
        }


        function updateTransactionSummary(filteredTransactions) {
            const totalIncomeFiltered = filteredTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + (Number(t.amount) || 0), 0);
            const totalExpenseFiltered = filteredTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + (Number(t.amount) || 0), 0);

            document.getElementById('summaryIncome').textContent = `Total Pemasukan (Filter): ${formatCurrency(totalIncomeFiltered)}`;
            document.getElementById('summaryExpense').textContent = `Total Pengeluaran (Filter): ${formatCurrency(totalExpenseFiltered)}`;
        }

        // MODIFIED: renderTransactions now expects already sorted transactions
        function renderTransactions(transactionsToPaginate, page = 1) {
            const container = document.getElementById('transactionsTable');
            const paginationControls = document.getElementById('paginationControls');
            container.innerHTML = '';
            paginationControls.innerHTML = '';

            if (!transactionsToPaginate || transactionsToPaginate.length === 0) {
                container.innerHTML = `<div class="empty-state" style="padding: 30px;"><i data-feather="info"></i><p>Tidak ada transaksi yang sesuai dengan filter dan urutan.</p></div>`;
                if (typeof feather !== 'undefined') feather.replace();
                return;
            }

            // Transactions are already sorted by applyTransactionFiltersAndRender

            // Adjust page number if it's out of bounds
            const totalPages = Math.ceil(transactionsToPaginate.length / transactionsPerPage);
            if (page > totalPages && totalPages > 0) {
                page = totalPages;
                currentTransactionPage = totalPages; // Update global current page
            }
            if (page < 1 && totalPages > 0) {
                page = 1;
                currentTransactionPage = 1;
            }


            const startIndex = (page - 1) * transactionsPerPage;
            const endIndex = page * transactionsPerPage;
            const paginatedTransactions = transactionsToPaginate.slice(startIndex, endIndex); // Use transactionsToPaginate directly


            let tableHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th class="no-column">No.</th>
                                <th>Tanggal</th>
                                <th>Keterangan</th>
                                <th style="text-align: right;">Nominal</th>
                                <th class="actions-column">Tindakan</th>
                            </tr>
                        </thead>
                        <tbody>`;

            paginatedTransactions.forEach((t, index) => {
                const displayIndex = startIndex + index + 1;
                const isIncome = t.type === 'income';
                const typeLabel = isIncome ? '(Pemasukan)' : '(Pengeluaran)';
                const descriptionText = `${t.description} <em style="font-size:0.8em; color:${isIncome ? 'var(--green)' : 'var(--red)'};">${typeLabel}</em>`;

                tableHTML += `
                    <tr>
                        <td class="no-column">${displayIndex}</td>
                        <td>${formatDate(t.date)}</td>
                        <td class="description-cell" title="${t.description} ${typeLabel}">${descriptionText}</td>
                        <td class="amount-cell ${isIncome ? 'income-amount' : 'expense-amount'}">
                            ${isIncome ? '+' : '-'} ${formatCurrency(t.amount)}
                        </td>
                        <td class="actions-column-cell">
                            <div class="transaction-actions-wrapper">
                                <button class="btn btn-icon edit-btn" onclick="showEditTransactionModal(${t.id})" title="Edit Transaksi">
                                    <i data-feather="edit-2"></i>
                                </button>
                                <button class="btn btn-icon delete-btn" onclick="showDeleteConfirm(${t.id})" title="Hapus Transaksi">
                                    <i data-feather="trash-2"></i>
                                </button>
                            </div>
                        </td>
                    </tr>`;
            });

            tableHTML += '</tbody></table></div>';
            container.innerHTML = tableHTML;

            renderPaginationControls(transactionsToPaginate.length, page);

            if (typeof feather !== 'undefined') feather.replace();
        }

        function renderPaginationControls(totalItems, currentPage) {
            const paginationControls = document.getElementById('paginationControls');
            const totalPages = Math.ceil(totalItems / transactionsPerPage);

            if (totalPages <= 1) {
                paginationControls.innerHTML = '';
                return;
            }

            let controlsHTML = '';

            controlsHTML += `
                <button class="btn btn-outline btn-sm" onclick="changeTransactionPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                    <i data-feather="chevron-left"></i> Seb
                </button>`;

            controlsHTML += `<span class="page-info">Hal ${currentPage} dari ${totalPages}</span>`;

            controlsHTML += `
                <button class="btn btn-outline btn-sm" onclick="changeTransactionPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                    Ber <i data-feather="chevron-right"></i>
                </button>`;

            paginationControls.innerHTML = controlsHTML;
            if (typeof feather !== 'undefined') feather.replace();
        }

        function changeTransactionPage(newPage) {
            const totalPages = Math.ceil(currentFilteredTransactions.length / transactionsPerPage);
            if (newPage >= 1 && newPage <= totalPages) {
                currentTransactionPage = newPage;
                renderTransactions(currentFilteredTransactions, currentTransactionPage);
            } else if (totalPages === 0 && newPage === 1) { // Handle case where all transactions are filtered out
                currentTransactionPage = 1;
                renderTransactions([], 1); // Render empty state
            }
        }


        // ===== CORE LOGIC FUNCTIONS (addExpense, addDoctor, etc. - CORE LOGIC UNCHANGED) =====
        async function addExpense() {
            const date = document.getElementById('expenseDateModal').value;
            const description = document.getElementById('expenseDescModal').value.trim();
            const amount = unformatNumber(document.getElementById('expenseAmountModal').value);

            if (!date || !description || !amount || amount <= 0) {
                showNotification('❌ Harap isi semua field pengeluaran dengan benar.', 'error');
                return;
            }

            const doctor = doctors.find(d => d.id == currentDoctorId);
            if (doctor) {
                const newTransaction = {
                    id: Date.now(),
                    date: date,
                    description: description,
                    amount: amount,
                    type: 'expense',
                    createdAt: new Date().toISOString() // Ensure createdAt is set
                };
                if (!Array.isArray(doctor.transactions)) doctor.transactions = []; // Ensure transactions array exists
                doctor.transactions.push(newTransaction);
                await saveUserData();
                // updateDoctorInfoUI(doctor); // This will be handled by applyTransactionFiltersAndRender via saveUserData or explicitly
                applyTransactionFiltersAndRender(); // Re-apply filters and sort
                closeModal('addExpenseModal');
                document.getElementById('addExpenseForm').reset();
                showNotification('✅ Pengeluaran berhasil dicatat!', 'success');
            } else {
                showNotification('❌ Dokter tidak ditemukan. Tidak dapat menambah pengeluaran.', 'error');
            }
        }

        async function addDoctor() {
            const name = document.getElementById('newDoctorName').value.trim();
            const initialDepositAmount = unformatNumber(document.getElementById('initialDeposit').value);

            if (!name) {
                showNotification('❌ Nama dokter tidak boleh kosong.', 'error');
                document.getElementById('newDoctorName').focus();
                return;
            }
            if (doctors.find(d => d.name.toLowerCase() === name.toLowerCase())) {
                showNotification('❌ Dokter dengan nama ini sudah terdaftar.', 'error');
                document.getElementById('newDoctorName').focus();
                return;
            }

            const newDoctor = {
                id: Date.now(),
                name: name,
                transactions: [], // Initialize as empty array
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            if (initialDepositAmount > 0) {
                const initialDepositTransaction = {
                    id: Date.now() + 1, // ensure unique ID
                    date: new Date().toISOString().split('T')[0],
                    description: 'Deposit Awal',
                    amount: initialDepositAmount,
                    type: 'income',
                    createdAt: new Date().toISOString() // Ensure createdAt is set
                };
                newDoctor.transactions.push(initialDepositTransaction);
            }

            doctors.push(newDoctor);
            await saveUserData();
            populateDoctorDropdown();
            selectDoctor(newDoctor.id); // This will trigger applyTransactionFiltersAndRender with default sort
            closeModal('addDoctorModal');
            showNotification(`✅ Dokter "${name}" berhasil ditambahkan!`, 'success');
            document.getElementById('newDoctorName').value = '';
            document.getElementById('initialDeposit').value = '';
            document.getElementById('nameHint').style.display = 'none'; // Hide hint after adding
        }

        async function addDeposit() {
            const amount = unformatNumber(document.getElementById('additionalDeposit').value);
            const description = document.getElementById('depositDesc').value.trim() || 'Tambah Deposit';

            if (!amount || amount <= 0) {
                showNotification('❌ Jumlah deposit tidak valid atau kosong.', 'error');
                document.getElementById('additionalDeposit').focus();
                return;
            }

            const doctor = doctors.find(d => d.id == currentDoctorId);
            if (doctor) {
                const depositTransaction = {
                    id: Date.now(),
                    date: new Date().toISOString().split('T')[0],
                    description: description,
                    amount: amount,
                    type: 'income',
                    createdAt: new Date().toISOString() // Ensure createdAt is set
                };
                if (!Array.isArray(doctor.transactions)) doctor.transactions = []; // Ensure transactions array exists
                doctor.transactions.push(depositTransaction);
                await saveUserData();
                // updateDoctorInfoUI(doctor);
                applyTransactionFiltersAndRender(); // Re-apply filters and sort
                closeModal('addDepositModal');
                document.getElementById('additionalDeposit').value = '';
                document.getElementById('depositDesc').value = '';
                showNotification('✅ Deposit berhasil ditambahkan!', 'success');
            } else {
                showNotification('❌ Dokter tidak ditemukan. Tidak dapat menambah deposit.', 'error');
            }
        }

        async function confirmDelete() { // Deletes a transaction
            const doctor = doctors.find(d => d.id == currentDoctorId);
            if (doctor && deleteTransactionId) {
                if (!Array.isArray(doctor.transactions)) doctor.transactions = [];
                const initialLength = doctor.transactions.length;
                doctor.transactions = doctor.transactions.filter(t => t.id != deleteTransactionId);

                if (doctor.transactions.length < initialLength) { // Check if a transaction was actually removed
                    doctor.updatedAt = new Date().toISOString();
                    await saveUserData();
                    // updateDoctorInfoUI(doctor);
                    applyTransactionFiltersAndRender(); // Re-apply filters and sort
                    showNotification('✅ Transaksi berhasil dihapus.', 'success');
                } else {
                    showNotification('ℹ️ Transaksi tidak ditemukan untuk dihapus.', 'info');
                }
                closeModal('confirmDeleteModal');
                deleteTransactionId = null;
            } else {
                closeModal('confirmDeleteModal');
                showNotification('❌ Gagal menghapus transaksi: Dokter atau ID transaksi tidak valid.', 'error');
                deleteTransactionId = null;
            }
        }


        async function confirmDeleteDoctor() {
            if (currentDoctorId) {
                const doctorToDelete = doctors.find(d => d.id == currentDoctorId);
                const doctorName = doctorToDelete ? doctorToDelete.name : "Dokter ini";

                doctors = doctors.filter(d => d.id != currentDoctorId);
                await saveUserData();

                populateDoctorDropdown();

                // Select another doctor if available, otherwise select null
                currentDoctorId = null; // Reset currentDoctorId before selecting new one
                if (doctors.length > 0) {
                    selectDoctor(doctors[0].id);
                } else {
                    selectDoctor(null);
                }

                closeModal('confirmDeleteDoctorModal');
                showNotification(`✅ ${doctorName} dan semua datanya berhasil dihapus.`, 'success');
            }
        }


        // ===== FORM & MODAL UI FUNCTIONS (ADAPTED) =====
        function showAddExpenseModal() {
            document.getElementById('addExpenseForm').reset();
            setTodayDate('expenseDateModal');
            document.getElementById('addExpenseModal').classList.add('show');
            document.getElementById('expenseDescModal').focus();
        }

        function checkDoctorName() {
            const nameInput = document.getElementById('newDoctorName');
            const name = nameInput.value.trim();
            const hintElement = document.getElementById('nameHint');

            if (name.length === 0) {
                hintElement.style.display = 'none';
                nameInput.style.borderColor = 'var(--border-color)';
                return;
            }

            const existingDoctor = doctors.find(d => d.name.toLowerCase() === name.toLowerCase());
            if (existingDoctor) {
                hintElement.textContent = 'Nama dokter ini sudah ada. Gunakan nama lain.';
                hintElement.style.color = 'var(--red)';
                nameInput.style.borderColor = 'var(--red)';
            } else {
                hintElement.textContent = 'Nama Tersedia';
                hintElement.style.color = 'var(--green)';
                nameInput.style.borderColor = 'var(--green)';
            }
            hintElement.style.display = 'block';
        }

        function showAddDoctorModal() {
            closeDrawer();
            setTimeout(() => {
                document.getElementById('addDoctorModal').classList.add('show');
                document.getElementById('newDoctorName').value = '';
                document.getElementById('initialDeposit').value = '';
                checkDoctorName(); // Reset hint
                document.getElementById('newDoctorName').focus();
            }, 50);
        }


        function showAddDepositModal() {
            document.getElementById('additionalDeposit').value = '';
            document.getElementById('depositDesc').value = '';
            document.getElementById('addDepositModal').classList.add('show');
            document.getElementById('additionalDeposit').focus();
        }

        function showDeleteConfirm(transactionId) {
            deleteTransactionId = transactionId;
            document.getElementById('confirmDeleteModal').classList.add('show');
        }

        function showDeleteDoctorModal() {
            const doctor = doctors.find(d => d.id == currentDoctorId);
            if (doctor) {
                document.getElementById('deleteDoctorText').textContent = `Anda yakin ingin menghapus "Dr. ${doctor.name}" beserta seluruh riwayat transaksinya? Tindakan ini tidak dapat diurungkan.`;
                document.getElementById('confirmDeleteDoctorModal').classList.add('show');
            } else {
                showNotification('ℹ️ Tidak ada dokter yang dipilih untuk dihapus.', 'info');
            }
        }

        function showExportModal() {
            const doctor = doctors.find(d => d.id == currentDoctorId);
            if (!doctor) {
                showNotification('❌ Pilih dokter terlebih dahulu untuk export laporan.', 'error');
                return;
            }
            if (!Array.isArray(doctor.transactions) || doctor.transactions.length === 0) {
                showNotification('ℹ️ Tidak ada transaksi untuk dokter ini yang bisa diexport.', 'info'); // Changed to info
                return;
            }
            document.getElementById('exportPDFModal').classList.add('show');
            document.getElementById('exportType').value = 'all';
            document.getElementById('dateRangeGroup').style.display = 'none';
            document.getElementById('exportFromDate').value = '';
            document.getElementById('exportToDate').value = new Date().toISOString().split('T')[0]; // Default to today
            document.getElementById('exportSort').value = 'newest';
            setupExportModalEventListeners(); // Ensure listeners are (re)attached
        }


        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.remove('show');
        }

        // ===== EDIT TRANSACTION LOGIC =====
        function showEditTransactionModal(transactionId) {
            currentEditingTransactionId = transactionId;
            const doctor = doctors.find(d => d.id == currentDoctorId);
            if (!doctor || !Array.isArray(doctor.transactions)) return;

            const transaction = doctor.transactions.find(t => t.id == transactionId);
            if (!transaction) return;

            document.getElementById('editTransactionId').value = transaction.id;
            document.getElementById('editTransactionDate').value = transaction.date;
            document.getElementById('editTransactionDesc').value = transaction.description;
            document.getElementById('editTransactionAmount').value = formatNumber(transaction.amount);
            document.getElementById('editTransactionType').value = transaction.type;


            document.getElementById('editTransactionModal').classList.add('show');
            if (typeof feather !== 'undefined') feather.replace();
        }

        async function saveEditedTransaction() {
            const transactionId = currentEditingTransactionId; // Use the stored ID
            const newDate = document.getElementById('editTransactionDate').value;
            const newDesc = document.getElementById('editTransactionDesc').value.trim();
            const newAmount = unformatNumber(document.getElementById('editTransactionAmount').value);
            // const newType = document.getElementById('editTransactionType').value; // Type is disabled, so it won't change

            if (!newDate || !newDesc || !newAmount || newAmount <= 0) {
                showNotification('❌ Harap isi semua field edit dengan benar.', 'error');
                return;
            }

            const doctor = doctors.find(d => d.id == currentDoctorId);
            if (doctor && Array.isArray(doctor.transactions)) {
                const transactionIndex = doctor.transactions.findIndex(t => t.id == transactionId);
                if (transactionIndex > -1) {
                    doctor.transactions[transactionIndex].date = newDate;
                    doctor.transactions[transactionIndex].description = newDesc;
                    doctor.transactions[transactionIndex].amount = newAmount;
                    // doctor.transactions[transactionIndex].type = newType; // Not needed as it's disabled
                    doctor.transactions[transactionIndex].updatedAt = new Date().toISOString(); // Update timestamp

                    await saveUserData();
                    // updateDoctorInfoUI(doctor);
                    applyTransactionFiltersAndRender(); // Re-apply filters and sort
                    closeModal('editTransactionModal');
                    showNotification('✅ Transaksi berhasil diperbarui!', 'success');
                } else {
                    showNotification('❌ Transaksi tidak ditemukan untuk diedit.', 'error');
                }
            } else {
                showNotification('❌ Dokter tidak ditemukan atau data transaksi tidak valid.', 'error');
            }
            currentEditingTransactionId = null;
        }


        // ===== PDF EXPORT LOGIC =====
        function setupExportModalEventListeners() {
            const exportTypeSelect = document.getElementById('exportType');
            const dateRangeGroup = document.getElementById('dateRangeGroup');

            // Remove existing listener to prevent multiple attachments if function is called multiple times
            // This requires storing the listener or using a flag, simpler approach is to just set it.
            exportTypeSelect.onchange = function () { // Direct assignment is simpler here
                dateRangeGroup.style.display = this.value === 'range' ? 'block' : 'none';
                if (this.value === 'range' && !document.getElementById('exportFromDate').value) {
                    const today = new Date();
                    const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
                    document.getElementById('exportFromDate').value = lastMonth.toISOString().split('T')[0];
                    document.getElementById('exportToDate').value = today.toISOString().split('T')[0];
                }
            };
        }


        function processExportToPDF() {
            const doctor = doctors.find(d => d.id == currentDoctorId);
            if (!doctor) {
                showNotification('❌ Dokter tidak ditemukan untuk export.', 'error');
                return;
            }
            if (!Array.isArray(doctor.transactions)) {
                showNotification('ℹ️ Format data transaksi dokter ini tidak valid.', 'info');
                return;
            }


            const exportType = document.getElementById('exportType').value;
            const exportSort = document.getElementById('exportSort').value; // This is for PDF internal sorting, not related to table sort
            const fromDateStr = document.getElementById('exportFromDate').value;
            const toDateStr = document.getElementById('exportToDate').value;

            let transactionsToExport = doctor.transactions.slice(); // Start with all transactions

            if (exportType === 'range') {
                if (!fromDateStr || !toDateStr) {
                    showNotification('❌ Harap pilih rentang tanggal untuk export.', 'error');
                    return;
                }
                const fromDate = new Date(fromDateStr);
                fromDate.setHours(0, 0, 0, 0);
                const toDate = new Date(toDateStr);
                toDate.setHours(23, 59, 59, 999);

                transactionsToExport = transactionsToExport.filter(t => {
                    const transactionDate = new Date(t.date);
                    return transactionDate >= fromDate && transactionDate <= toDate;
                });

                if (transactionsToExport.length === 0) {
                    showNotification('ℹ️ Tidak ada transaksi ditemukan dalam rentang tanggal yang dipilih.', 'info');
                    return;
                }
            }
            // Sort for PDF export based on PDF modal's sort option
            transactionsToExport.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                let comparison = exportSort === 'newest' ? dateB - dateA : dateA - dateB;
                if (comparison === 0) { // Secondary sort by createdAt if dates are identical
                    const createdAtA = a.createdAt ? new Date(a.createdAt) : new Date(0);
                    const createdAtB = b.createdAt ? new Date(b.createdAt) : new Date(0);
                    comparison = exportSort === 'newest' ? createdAtB - createdAtA : createdAtA - createdAtB;
                }
                return comparison;
            });

            try {
                const { jsPDF } = window.jspdf;
                if (!jsPDF) {
                    showNotification('❌ Library PDF (jsPDF) tidak ditemukan.', 'error');
                    return;
                }
                const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });

                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text(`Laporan Keuangan - Dr. ${doctor.name}`, 14, 20);

                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Dicetak oleh: ${(currentUser && currentUser.displayName) || (currentUser && currentUser.email) || 'Pengguna Aplikasi'}`, 14, 26);
                doc.text(`Tanggal Cetak: ${new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`, 14, 32);

                let currentY = 40;
                if (exportType === 'range') {
                    doc.text(`Periode Laporan: ${formatDate(fromDateStr)} s/d ${formatDate(toDateStr)}`, 14, currentY);
                    currentY += 8;
                }

                // Overall financial summary for the doctor (from all their transactions)
                const overallTotalIncome = (Array.isArray(doctor.transactions) ? doctor.transactions : [])
                    .filter(t => t.type === 'income')
                    .reduce((sum, t) => sum + (Number(t.amount) || 0), 0);
                const overallTotalExpense = (Array.isArray(doctor.transactions) ? doctor.transactions : [])
                    .filter(t => t.type === 'expense')
                    .reduce((sum, t) => sum + (Number(t.amount) || 0), 0);
                const overallRemainingBalance = overallTotalIncome - overallTotalExpense;

                // Summary specific to the EXPORTED (potentially filtered) transactions
                const exportedTotalIncome = transactionsToExport
                    .filter(t => t.type === 'income')
                    .reduce((sum, t) => sum + (Number(t.amount) || 0), 0);
                const exportedTotalExpense = transactionsToExport
                    .filter(t => t.type === 'expense')
                    .reduce((sum, t) => sum + (Number(t.amount) || 0), 0);


                // Data for summary table
                let summaryBody = [
                    ['Total Deposit Keseluruhan (Dr. ' + doctor.name + ')', formatCurrency(overallTotalIncome)],
                    ['Total Pengeluaran Keseluruhan (Dr. ' + doctor.name + ')', formatCurrency(overallTotalExpense)],
                ];
                const sisaSaldoStyle = {
                    content: formatCurrency(overallRemainingBalance),
                    styles: {
                        halign: 'right',
                        fillColor: overallRemainingBalance < 0 ? [239, 68, 68] : [16, 185, 129], // var(--red) or var(--green)
                        textColor: [255, 255, 255]
                    }
                };
                summaryBody.push(['Sisa Saldo Keseluruhan (Dr. ' + doctor.name + ')', sisaSaldoStyle]);

                if (exportType === 'range') { // Add summary for the filtered period if applicable
                    // Add a spacer row if it's a ranged report
                    summaryBody.push([{ content: '', colSpan: 2, styles: { minCellHeight: 3 } }]); // Baris kosong sebagai jarak

                    summaryBody.push(['Total Pemasukan (Berdasarkan Tanggal)', formatCurrency(exportedTotalIncome)]);
                    summaryBody.push(['Total Pengeluaran (Berdasarkan Tanggal)', formatCurrency(exportedTotalExpense)]);
                }


                doc.autoTable({
                    startY: currentY,
                    head: [['Deskripsi Ringkasan', 'Jumlah']],
                    body: summaryBody,
                    theme: 'grid',
                    headStyles: { fillColor: [79, 70, 229] }, // Indigo
                    columnStyles: { 1: { halign: 'right' } },
                    margin: { top: 10 },
                    didDrawCell: (data) => { // Custom drawing for spacer
                        if (data.row.index === summaryBody.findIndex(row => row[0].content === '' && row[0].colSpan === 2)) {
                            // If it's the spacer row, remove borders by drawing over them with white (or background color)
                            // This is a bit of a hack as autoTable might not directly support fully borderless cells in this context easily.
                            // For a cleaner approach, one might need to manually draw tables or use more advanced jsPDF features.
                            // However, for a simple visual space, this often suffices or one might adjust cell padding/margins if supported by the theme.
                            // For now, we rely on the minCellHeight for visual spacing.
                            // A truly borderless spacer row might need more complex handling depending on the theme.
                        }
                    }
                });
                currentY = doc.lastAutoTable.finalY + 10;

                if (transactionsToExport.length > 0) {
                    doc.autoTable({
                        startY: currentY,
                        head: [['No.', 'Tanggal', 'Keterangan', 'Jenis', 'Nominal (Rp)']],
                        body: transactionsToExport.map((t, index) => [
                            index + 1,
                            formatDate(t.date),
                            t.description,
                            t.type === 'income' ? 'Pemasukan' : 'Pengeluaran',
                            { content: formatCurrency(t.amount), styles: { halign: 'right' } }
                        ]),
                        theme: 'striped',
                        headStyles: { fillColor: [79, 70, 229] }, // Indigo
                        columnStyles: {
                            0: { cellWidth: 10 },
                            1: { cellWidth: 25 },
                            2: { cellWidth: 'auto' },
                            3: { cellWidth: 25 },
                            4: { cellWidth: 30, halign: 'right' }
                        },
                        didParseCell: function (data) {
                            if (data.row.section === 'body' && data.column.dataKey === 3) { // Column for "Jenis"
                                if (data.cell.raw === 'Pemasukan') {
                                    data.cell.styles.textColor = [16, 185, 129]; // var(--green)
                                } else if (data.cell.raw === 'Pengeluaran') {
                                    data.cell.styles.textColor = [239, 68, 68]; // var(--red)
                                }
                            }
                        }
                    });
                } else {
                    doc.text('Tidak ada transaksi untuk ditampilkan dalam periode/filter ini.', 14, currentY);
                }

                let filename = `Laporan_${doctor.name.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(filename);
                showNotification('✅ Laporan PDF berhasil diexport!', 'success');
            } catch (error) {
                console.error('Kesalahan saat export PDF:', error);
                showNotification('❌ Gagal export PDF: ' + error.message, 'error');
            }
            closeModal('exportPDFModal');
        }

        // ===== CALCULATOR LOGIC =====
        let calculatorCurrentExpression = '';

        function showCalculatorModal(targetId) {
            calculatorTargetInputId = targetId;
            const targetInput = document.getElementById(targetId);
            if (targetInput && targetInput.value) {
                calculatorCurrentExpression = String(unformatNumber(targetInput.value));
                document.getElementById('calculatorDisplay').value = calculatorCurrentExpression;
            } else {
                document.getElementById('calculatorDisplay').value = '';
                calculatorCurrentExpression = '';
            }
            document.getElementById('calculatorModal').classList.add('show');
            if (typeof feather !== 'undefined') feather.replace();
        }

        function appendToCalculatorDisplay(value) {
            const display = document.getElementById('calculatorDisplay');
            const lastChar = calculatorCurrentExpression.slice(-1);
            const operators = ['/', '*', '-', '+'];

            if (value === '.' && calculatorCurrentExpression.includes('.')) {
                const parts = calculatorCurrentExpression.split(/[+\-*/]/);
                if (parts[parts.length - 1].includes('.')) return; // Prevent multiple decimals in current number segment
            }


            if (operators.includes(value)) {
                if (calculatorCurrentExpression === '' && value !== '-') return;
                if (operators.includes(lastChar)) {
                    calculatorCurrentExpression = calculatorCurrentExpression.slice(0, -1) + value;
                } else {
                    calculatorCurrentExpression += value;
                }
            } else {
                calculatorCurrentExpression += value;
            }
            display.value = calculatorCurrentExpression;
        }

        function clearCalculatorDisplay() {
            calculatorCurrentExpression = '';
            document.getElementById('calculatorDisplay').value = '';
        }

        function calculateResult() {
            const display = document.getElementById('calculatorDisplay');
            try {
                let sanitizedExpression = calculatorCurrentExpression.replace(/[^-()\d/*+.]/g, '');
                if (sanitizedExpression === '') {
                    display.value = '0';
                    calculatorCurrentExpression = '0';
                    return;
                }
                // Avoid direct eval. Use Function constructor for safer evaluation.
                let result = new Function('return ' + sanitizedExpression)();
                if (isNaN(result) || !isFinite(result)) {
                    throw new Error("Invalid calculation result");
                }
                display.value = result;
                calculatorCurrentExpression = result.toString();
            } catch (error) {
                display.value = 'Error';
                calculatorCurrentExpression = '';
                console.error("Calculator error:", error);
            }
        }

        function applyCalculatorResult() {
            const display = document.getElementById('calculatorDisplay');
            // Ensure calculation is performed if expression changed or current is Error
            if (calculatorCurrentExpression !== display.value || display.value === 'Error' || display.value === '') {
                if (calculatorCurrentExpression === '') { // if display is empty, result is 0
                    display.value = '0';
                } else {
                    calculateResult(); // Calculate if not already the result
                }
                if (display.value === 'Error') {
                    showNotification("Hasil kalkulator tidak valid.", "error");
                    return;
                }
            }


            const result = parseFloat(display.value);
            if (!isNaN(result) && calculatorTargetInputId) {
                const targetInput = document.getElementById(calculatorTargetInputId);
                if (targetInput) {
                    targetInput.value = result; // Set the raw number
                    formatAmountInput(targetInput); // Then format it
                }
            }
            closeModal('calculatorModal');
        }


        // ===== DRAWER/SIDEBAR TOGGLE LOGIC =====
        function toggleDrawer() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mainContentOverlay');
            const body = document.body;
            sidebar.classList.toggle('open');
            body.classList.toggle('drawer-open'); // This class on body prevents main content scroll
            // Overlay display is handled by CSS based on body.drawer-open and sidebar.open
        }


        function closeDrawer() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mainContentOverlay');
            const body = document.body;
            sidebar.classList.remove('open');
            body.classList.remove('drawer-open');
            // Overlay display is handled by CSS
        }

        // ===== FILTER TOGGLE LOGIC =====
        function toggleFilterSection() {
            const filterSection = document.getElementById('transactionFilters');
            const toggleButton = document.getElementById('toggleFilterBtn');
            const isOpen = filterSection.classList.toggle('open');
            if (isOpen) {
                toggleButton.innerHTML = '<i data-feather="chevron-up"></i> <span>Sembunyikan Filter</span>';
            } else {
                toggleButton.innerHTML = '<i data-feather="filter"></i> <span>Tampilkan Filter</span>';
            }
            if (typeof feather !== 'undefined') feather.replace();
        }


        // ===== EVENT LISTENERS SETUP =====
        function setupEventListeners() {
            document.getElementById('googleLoginBtn').onclick = signInWithGoogle;

            const logoutBtnDesktop = document.getElementById('logoutBtnDesktop');
            if (logoutBtnDesktop) logoutBtnDesktop.onclick = signOut;

            const logoutBtnSidebar = document.getElementById('logoutBtnSidebar');
            if (logoutBtnSidebar) logoutBtnSidebar.onclick = () => {
                signOut();
                closeDrawer();
            };

            const addExpenseModalButton = document.getElementById('addExpenseModalBtn');
            if (addExpenseModalButton) addExpenseModalButton.onclick = showAddExpenseModal;

            document.getElementById('addExpenseForm').onsubmit = e => { e.preventDefault(); addExpense(); };
            document.getElementById('editTransactionForm').onsubmit = e => { e.preventDefault(); saveEditedTransaction(); };

            const hamburgerBtn = document.getElementById('hamburgerBtn');
            if (hamburgerBtn) hamburgerBtn.onclick = toggleDrawer;

            const overlay = document.getElementById('mainContentOverlay');
            if (overlay) overlay.onclick = closeDrawer;

            // Dokter Dropdown Listeners
            const dokterDropdownActiveEl = document.getElementById('dokterDropdownActive');
            if (dokterDropdownActiveEl) dokterDropdownActiveEl.onclick = toggleDoctorDropdown;

            const dokterSearchInputEl = document.getElementById('dokterSearchInput');
            if (dokterSearchInputEl) dokterSearchInputEl.oninput = (e) => populateDoctorDropdown(e.target.value);

            // Add Doctor button in sidebar
            const addDoctorSidebarButton = document.getElementById('addDoctorSidebarBtn');
            if (addDoctorSidebarButton) addDoctorSidebarButton.onclick = showAddDoctorModal;


            // Transaction Filter Listeners (oninput for text, onchange for date/select for better performance)
            document.getElementById('searchKeterangan').oninput = applyTransactionFiltersAndRender;
            document.getElementById('filterTanggalMulai').onchange = applyTransactionFiltersAndRender;
            document.getElementById('filterTanggalAkhir').onchange = applyTransactionFiltersAndRender;
            document.getElementById('filterJenisTransaksi').onchange = applyTransactionFiltersAndRender;
            document.getElementById('toggleFilterBtn').onclick = toggleFilterSection;

            // NEW: Event listener for sort dropdown
            const sortTransaksiSelect = document.getElementById('sortTransaksi');
            if (sortTransaksiSelect) {
                sortTransaksiSelect.onchange = () => {
                    currentSortOrder = sortTransaksiSelect.value;
                    currentTransactionPage = 1; // Reset to first page on sort change
                    applyTransactionFiltersAndRender();
                };
            }


            window.addEventListener('click', function (event) {
                // Close modals if click is outside their content
                document.querySelectorAll('.modal.show').forEach(modal => {
                    const modalContent = modal.querySelector('.modal-content');
                    // Check if modalContent exists and if the click is directly on the modal backdrop
                    if (modalContent && event.target == modal) {
                        closeModal(modal.id);
                    }
                });
                // Close doctor dropdown if click is outside
                const dokterDropdownContainer = document.querySelector('.dokter-dropdown-container');
                if (dokterDropdownContainer && !dokterDropdownContainer.contains(event.target) && document.getElementById('dokterDropdownListWrapper').classList.contains('open')) {
                    closeDoctorDropdown();
                }
            });

            window.addEventListener('keydown', function (event) {
                if (event.key === "Escape" || event.key === "Esc") {
                    document.querySelectorAll('.modal.show').forEach(modal => closeModal(modal.id));
                    if (document.getElementById('sidebar').classList.contains('open')) {
                        closeDrawer();
                    }
                    if (document.getElementById('dokterDropdownListWrapper').classList.contains('open')) {
                        closeDoctorDropdown();
                    }
                }
            });
        }

        // ===== APPLICATION INITIALIZATION =====
        window.onload = function () {
            console.log('Aplikasi Sistem Deposit Dokter sedang diinisialisasi...');
            if (typeof feather !== 'undefined') feather.replace();
            updateConnectionStatus();
            setupEventListeners();

            initializeFirebase();

            // Delay initAuth slightly to ensure Firebase SDKs are fully ready, especially with compat versions.
            setTimeout(() => {
                initAuth();
            }, 150);
        };

        if (typeof feather === 'undefined') {
            console.warn('Feather Icons CDN tidak termuat. Ikon mungkin tidak tampil.');
            // Provide a mock feather object if it's not loaded to prevent errors
            window.feather = { replace: () => { console.warn("feather.replace called but Feather Icons not loaded."); } };
        }

    </script>
</body>

</html>
