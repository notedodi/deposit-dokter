<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Deposit Dokter - Wowdash Style</title>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Ikon (Feather Icons) -->
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        /* ===== PRESET & UTILITIES ===== */
        :root {
            --primary-color: #4f46e5;
            /* Indigo-600 from Tailwind */
            --primary-hover: #4338ca;
            /* Indigo-700 */
            --secondary-color: #64748b;
            /* Slate-500 */
            --background-color: #f1f5f9;
            /* Slate-100 */
            --card-background: #ffffff;
            --text-primary: #1e293b;
            /* Slate-800 */
            --text-secondary: #64748b;
            /* Slate-500 */
            --border-color: #e2e8f0;
            /* Slate-200 */
            --green: #10b981;
            /* Emerald-500 */
            --red: #ef4444;
            /* Red-500 */
            --yellow: #f59e0b;
            /* Amber-500 */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body.drawer-open {
            overflow: hidden;
            /* Prevent scrolling of main content when drawer is open */
        }


        /* ===== LOGIN SCREEN STYLES ===== */
        .login-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--background-color);
            text-align: center;
            padding: 20px;
        }

        .login-card {
            background: var(--card-background);
            padding: 40px 30px;
            border-radius: 20px;
            /* Increased border-radius */
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
            /* Softer shadow */
            color: var(--text-primary);
            max-width: 400px;
            width: 100%;
        }

        .login-card h1 {
            font-size: 1.8rem;
            /* Slightly smaller */
            margin-bottom: 10px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .login-card p {
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-size: 1rem;
            /* Standardized size */
        }

        .google-login-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: #4285f4;
            /* Google Blue */
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            /* Rounded button */
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            text-decoration: none;
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
            /* Button shadow */
        }

        .google-login-btn:hover {
            background: #3367d6;
            /* Darker Google Blue on hover */
        }

        .google-icon {
            width: 20px;
            height: 20px;
        }

        /* ===== LOADING & CONNECTION STATUS ===== */
        .loading {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: var(--background-color);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .connection-status {
            position: fixed;
            bottom: 20px;
            /* Positioned at bottom-left */
            left: 20px;
            padding: 8px 12px;
            border-radius: 25px;
            /* Pill shape */
            font-size: 13px;
            font-weight: 500;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .connection-status.online {
            background: var(--green);
            color: white;
        }

        .connection-status.offline {
            background: var(--red);
            color: white;
        }

        .connection-status.syncing {
            background: var(--yellow);
            color: white;
        }

        /* ===== MAIN APP LAYOUT ===== */
        .app-layout {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 260px;
            background-color: var(--card-background);
            padding: 24px;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease-in-out;
            /* Smooth transition for drawer */
            z-index: 1002;
            /* Ensure sidebar is above content but below overlay if used */
        }

        .sidebar-header {
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-header h1 {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .sidebar-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            padding-left: 5px;
            /* Slight indent for title */
        }

        #doctorList {
            list-style: none;
            margin-bottom: 20px;
            flex-grow: 1;
            /* Allows list to take available space */
            overflow-y: auto;
            /* Scroll if many doctors */
        }

        #doctorList li {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 4px;
            /* Space between items */
        }

        #doctorList li:hover {
            background-color: #f8fafc;
            /* Light hover for non-active items */
            color: var(--primary-color);
        }

        #doctorList li.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 8px rgba(79, 70, 229, 0.2);
            /* Shadow for active item */
        }

        #doctorList li.active i {
            stroke: white;
            /* Ensure icon color matches text */
        }

        /* Styling for empty doctor list state */
        #doctorList .doctor-list-empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            opacity: 0.8;
            cursor: default;
            /* Not clickable */
            border: 1px dashed var(--border-color);
            border-radius: 8px;
            margin: 10px 0;
            /* Add some margin */
            min-height: 100px;
            /* Ensure it has some height */
        }

        #doctorList .doctor-list-empty-state i {
            width: 32px;
            height: 32px;
            margin-bottom: 12px;
        }

        #doctorList .doctor-list-empty-state span {
            font-size: 0.9rem;
            line-height: 1.5;
        }


        .sidebar-actions {
            margin-top: auto;
            /* Pushes this div to the bottom of the sidebar */
            padding-top: 20px;
            /* Space above action buttons */
            border-top: 1px solid var(--border-color);
            /* Separator line */
        }

        .sidebar-actions .btn {
            width: 100%;
            margin-top: 10px;
        }

        .sidebar-actions .btn:first-child {
            margin-top: 0;
        }

        #deleteDoctorBtn {
            display: none;
            /* Initially hidden, JS will control visibility */
        }

        #logoutBtnSidebar {
            display: none;
            /* Hidden by default, shown on mobile drawer */
        }


        .main-content {
            flex: 1;
            padding: 24px 32px;
            /* Standard padding */
            overflow-y: auto;
            /* Scroll for main content if needed */
            position: relative;
            /* For potential overlay or other positioned elements */
        }

        .main-content-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 1001;
            /* Below sidebar drawer, above main content */
        }

        body.drawer-open .main-content-overlay {
            display: block;
        }


        /* ===== HEADER ===== */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .header h2 {
            /* Main page title */
            font-size: 1.8rem;
            font-weight: 700;
        }

        .header p {
            /* Subtitle for page */
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .header-title-block {
            /* Wrapper for h2 and p */
            flex-grow: 1;
            /* Allows title block to take space */
        }

        .hamburger-btn {
            display: none;
            /* Hidden by default, shown on mobile */
            background: none;
            border: none;
            color: var(--text-primary);
            padding: 8px;
            cursor: pointer;
            margin-right: 10px;
            /* Space between hamburger and title */
        }

        .hamburger-btn i {
            width: 24px;
            height: 24px;
        }


        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
            /* Prevent user-info from shrinking */
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--primary-color);
            object-fit: cover;
            /* Ensure avatar image fits well */
        }

        .logout-btn-desktop {
            /* Renamed for clarity */
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 8px;
            /* Make it easier to click */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logout-btn-desktop:hover {
            background-color: #f1f5f9;
            /* Light background on hover */
            color: var(--primary-color);
        }

        /* ===== STAT CARDS (BALANCE) ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            /* Responsive grid */
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--card-background);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 8px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.07);
        }

        .stat-card-title {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .stat-card-value {
            font-size: 1.7rem;
            font-weight: 700;
        }

        #remainingBalance.negative {
            color: var(--red);
        }

        #remainingBalance.positive {
            color: var(--green);
        }

        /* ===== ACTION BUTTONS & FORMS ===== */
        .actions-bar {
            background: var(--card-background);
            padding: 16px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            /* Allow buttons to wrap on smaller screens */
            align-items: center;
            margin-bottom: 24px;
            /* Added margin */
        }

        .btn {
            display: inline-flex;
            /* Use inline-flex for better alignment */
            align-items: center;
            justify-content: center;
            /* Center content in button */
            gap: 8px;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            white-space: nowrap;
            /* Prevent button text from wrapping */
        }

        .btn i {
            /* Style for Feather icons in buttons */
            width: 16px;
            height: 16px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-success {
            background: var(--green);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        /* Darker green */
        .btn-danger {
            background: var(--red);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        /* Darker red */
        .btn-outline {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .btn-outline:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
        }

        /* Slate-300 */
        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        .btn-icon {
            /* For icon-only buttons like edit/delete in table */
            padding: 6px;
            width: 32px;
            /* Fixed width */
            height: 32px;
            /* Fixed height */
            flex-shrink: 0;
            /* Prevent shrinking */
        }

        .btn-icon i {
            margin: 0;
            /* No gap for icon-only buttons */
        }


        .expense-form-card {
            /* This class might be removed if form is only in modal */
            background: var(--card-background);
            padding: 24px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            margin-top: 24px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select {
            /* Apply to select as well */
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            background-color: white;
            /* Ensure select has white background */
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px #c7d2fe;
            /* Indigo-200 focus ring */
        }

        .input-with-icon {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-with-icon input {
            padding-right: 40px;
            /* Space for the icon */
        }

        .input-with-icon .calculator-trigger-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--secondary-color);
        }

        .input-with-icon .calculator-trigger-icon:hover {
            color: var(--primary-color);
        }


        /* ===== TRANSACTIONS TABLE ===== */
        .transactions-card {
            background: var(--card-background);
            padding: 24px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            margin-top: 24px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border-color);
            /* Thicker bottom border for header */
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        th.no-column {
            /* Style for "No." column */
            width: 50px;
            /* Adjust width as needed */
            text-align: center;
        }

        th.actions-column {
            /* Style for "Tindakan" column */
            width: 100px;
            /* Adjust width to fit two icon buttons */
            text-align: right;
            /* Align header text to right */
        }


        td {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
            vertical-align: middle;
        }

        td.no-column {
            text-align: center;
        }

        td.actions-column-cell {
            /* New class for the TD containing actions */
            text-align: center;
            /* Default center alignment for the wrapper */
            vertical-align: middle;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover td {
            background-color: #f8fafc;
        }

        /* Row hover effect */

        .amount-cell {
            font-weight: 600;
            text-align: right;
        }

        .income-amount {
            color: var(--green);
        }

        .expense-amount {
            color: var(--red);
        }

        .description-cell {
            max-width: 250px;
            /* Limit width */
            /* white-space: nowrap;  Allow wrapping for better readability */
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: default;
            /* Indicate it's hoverable for full text if implemented */
        }

        .transaction-actions-wrapper {
            /* Wrapper for action buttons */
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            /* Default to right on desktop */
            align-items: center;
        }

        .edit-btn {
            background: #e0e7ff;
            /* Indigo-100 */
            color: var(--primary-color);
        }

        .edit-btn:hover {
            background: var(--primary-color);
            color: white;
        }

        .delete-btn {
            background: #fee2e2;
            /* Red-100 */
            color: var(--red);
        }

        .delete-btn:hover {
            background: var(--red);
            color: white;
        }

        .delete-btn i,
        .edit-btn i {
            width: 14px;
            height: 14px;
        }

        /* Pagination Styles */
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            gap: 8px;
        }

        .pagination-controls .btn {
            min-width: 36px;
            /* Ensure buttons have a decent size */
        }

        .pagination-controls .btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .pagination-controls .btn:disabled {
            background-color: var(--border-color);
            color: var(--text-secondary);
            cursor: not-allowed;
            opacity: 0.7;
        }

        .page-info {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin: 0 10px;
        }


        /* ===== EMPTY STATE & MODAL ===== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            background-color: #fdfdff;
            /* Slightly off-white */
        }

        .empty-state i {
            width: 48px;
            height: 48px;
            margin-bottom: 16px;
            color: var(--secondary-color);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(30, 41, 59, 0.5);
            /* Slate-800 with opacity */
            z-index: 1000;
            display: none;
            /* Hidden by default */
            align-items: center;
            justify-content: center;
            padding: 20px;
            /* Padding for smaller screens */
        }

        .modal.show {
            display: flex;
        }

        /* Class to show modal */

        .modal-content {
            background: white;
            padding: 30px;
            width: 100%;
            /* Full width on small screens */
            max-width: 450px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-content h3 {
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 30px;
            justify-content: flex-end;
        }

        /* ===== CALCULATOR MODAL STYLES ===== */
        .calculator-content {
            max-width: 320px;
            /* Smaller width for calculator */
            padding: 20px;
        }

        .calculator-display-container {
            margin-bottom: 15px;
        }

        #calculatorDisplay {
            width: 100%;
            padding: 12px;
            font-size: 1.8rem;
            text-align: right;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: #f8fafc;
            /* Light background for display */
            color: var(--text-primary);
            font-family: 'Inter', monospace;
            /* Monospace for better number alignment */
        }

        .calculator-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .calculator-buttons button {
            padding: 15px;
            font-size: 1.2rem;
            font-weight: 500;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: #f9fafb;
            /* Light gray for buttons */
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .calculator-buttons button:hover {
            background-color: #f1f5f9;
            /* Slightly darker on hover */
        }

        .calculator-buttons button.operator {
            background-color: #e2e8f0;
            /* Different color for operators */
            color: var(--primary-color);
        }

        .calculator-buttons button.operator:hover {
            background-color: #cbd5e1;
        }

        .calculator-buttons button.primary {
            /* For OK/Apply button */
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .calculator-buttons button.primary:hover {
            background-color: var(--primary-hover);
        }

        .calculator-buttons button.danger {
            /* For C/Clear button */
            background-color: #fee2e2;
            /* Light red */
            color: var(--red);
        }

        .calculator-buttons button.danger:hover {
            background-color: #fecaca;
            /* Darker light red */
        }

        .calculator-buttons .span-2 {
            grid-column: span 2;
        }


        /* ===== NOTIFICATION ===== */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 2000;
            transform: translateX(calc(100% + 20px));
            /* Start off-screen */
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: var(--green);
        }

        .notification.error {
            background: var(--red);
        }

        .notification.info {
            background: #3b82f6;
        }

        /* Blue-500 */

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 992px) {

            /* Tablet and below */
            .sidebar {
                position: fixed;
                /* Changed for drawer behavior */
                top: 0;
                left: 0;
                height: 100%;
                transform: translateX(-100%);
                /* Initially hidden off-screen */
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
                border-right: none;
                /* No border when it's a drawer */
            }

            .sidebar.open {
                transform: translateX(0);
                /* Slide in when open */
            }

            #doctorList {
                display: block;
                /* Revert to block for vertical scrolling in drawer */
                overflow-x: hidden;
                overflow-y: auto;
                white-space: normal;
            }

            #doctorList li {
                min-width: auto;
                /* Reset min-width */
            }

            .main-content {
                padding: 20px;
            }

            .header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }

            .hamburger-btn {
                display: inline-flex;
                /* Show hamburger on mobile */
            }

            .user-info .logout-btn-desktop {
                display: none;
                /* Hide desktop logout button on mobile */
            }

            .sidebar-actions #logoutBtnSidebar {
                display: inline-flex;
                /* Show sidebar logout button when sidebar is open (mobile) */
            }
        }

        @media (max-width: 600px) {

            /* Mobile */
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .actions-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }

            .main-content {
                padding: 15px;
            }

            .header h2 {
                font-size: 1.5rem;
            }

            .header p {
                display: none;
            }

            /* Hide subtitle on very small screens */
            td,
            th {
                padding: 10px 8px;
                font-size: 0.85rem;
            }

            .actions-bar .btn {
                width: 100%;
            }

            .actions-bar .btn-danger {
                width: 100%;
                margin-left: 0;
            }

            .modal-buttons .btn {
                width: auto;
            }

            .sidebar .sidebar-actions .btn {
                width: 100%;
            }

            .pagination-controls {
                flex-wrap: wrap;
                /* Allow pagination buttons to wrap */
                justify-content: center;
            }

            .pagination-controls .btn {
                padding: 8px 12px;
                /* Slightly smaller buttons on mobile */
            }

            th.actions-column {
                text-align: center;
                min-width: 80px;
                width: auto;
            }

            td.actions-column-cell .transaction-actions-wrapper {
                justify-content: center;
            }

            .transaction-actions-wrapper .btn-icon {
                padding: 5px;
                width: 28px;
                height: 28px;
            }

            .transaction-actions-wrapper .btn-icon i {
                width: 12px;
                height: 12px;
            }

            .calculator-content {
                max-width: 100%;
                /* Full width on small screens for calculator */
                padding: 15px;
            }

            .calculator-buttons button {
                padding: 12px;
                font-size: 1.1rem;
            }


        }
    </style>
</head>

<body>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading">
        <div class="loading-spinner"></div>
        <p>Memuat aplikasi...</p>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen" style="display: none;">
        <div class="login-card">
            <h1><i data-feather="activity"></i>Sistem Deposit Dokter</h1>
            <p>Kelola keuangan dokter dengan mudah dan modern.</p>
            <button id="googleLoginBtn" class="google-login-btn">
                <img src="https://www.google.com/images/branding/googleg/1x/googleg_standard_color_28dp.png" alt="G"
                    class="google-icon" />
                Masuk dengan Google
            </button>
            <div style="margin-top: 20px; font-size: 0.9rem; color: #94a3b8;">
                Data Anda aman dan tersinkronisasi di cloud.
            </div>
        </div>
    </div>

    <!-- Main Application Layout -->
    <div id="mainApp" class="app-layout" style="display: none;">
        <!-- Sidebar / Drawer -->
        <aside id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <i data-feather="gitlab" style="color: var(--primary-color); width:28px; height:28px;"></i>
                <h1>WINGMAN!</h1>
            </div>

            <p class="sidebar-title">Manajemen Dokter</p>
            <ul id="doctorList">
                <!-- Doctor list will be populated by JavaScript -->
            </ul>
            <div class="sidebar-actions">
                <button class="btn btn-primary" onclick="showAddDoctorModal()">
                    <i data-feather="plus-circle"></i> Tambah Dokter Baru
                </button>
                <button class="btn btn-danger" onclick="showDeleteDoctorModal()" id="deleteDoctorBtn">
                    <i data-feather="trash-2"></i> Hapus Dokter Terpilih
                </button>
                <button class="btn btn-outline" id="logoutBtnSidebar" onclick="signOut()">
                    <i data-feather="log-out"></i> Keluar
                </button>
            </div>
        </aside>
        <div id="mainContentOverlay" class="main-content-overlay"></div>


        <!-- Main Content Area -->
        <main id="mainContent" class="main-content">
            <!-- Header Section -->
            <header class="header">
                <button id="hamburgerBtn" class="hamburger-btn">
                    <i data-feather="menu"></i>
                </button>
                <div class="header-title-block">
                    <h2 id="welcomeHeader">Dasbor Utama</h2>
                    <p id="welcomeSubheader">Selamat datang! Pilih dokter untuk memulai.</p>
                </div>
                <div class="user-info">
                    <img id="userAvatar" class="user-avatar" src="" alt="Foto Pengguna">
                    <button id="logoutBtnDesktop" class="logout-btn-desktop" title="Keluar" onclick="signOut()">
                        <i data-feather="log-out"></i>
                    </button>
                </div>
            </header>

            <!-- Placeholder for when no doctor is selected -->
            <div id="noDoctorSelected" class="empty-state">
                <i data-feather="users"></i>
                <h3>Pilih atau Tambah Dokter</h3>
                <p>Untuk melihat detail keuangan, silakan pilih dokter dari daftar di samping atau tambahkan dokter
                    baru.</p>
            </div>

            <!-- Doctor-specific content (shown when a doctor is selected) -->
            <div id="doctorInfo" style="display: none;">
                <!-- Balance Statistics Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="stat-card-title">Total Deposit Diterima</span>
                        <span class="stat-card-value" id="totalDeposit">Rp 0</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-card-title">Total Pengeluaran Dicatat</span>
                        <span class="stat-card-value" id="totalExpense">Rp 0</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-card-title">Sisa Saldo Saat Ini</span>
                        <span class="stat-card-value" id="remainingBalance">Rp 0</span>
                    </div>
                </div>

                <!-- Action Bar -->
                <div class="actions-bar">
                    <button class="btn btn-success" onclick="showAddDepositModal()">
                        <i data-feather="arrow-down-circle"></i> Tambah Deposit
                    </button>
                    <button class="btn btn-primary" id="addExpenseModalBtn" onclick="showAddExpenseModal()">
                        <i data-feather="arrow-up-circle"></i> Tambah Pengeluaran
                    </button>
                    <button class="btn btn-outline" onclick="showExportModal()">
                        <i data-feather="file-text"></i> Export Laporan
                    </button>
                </div>

                <!-- Transactions Table Card -->
                <div id="transactionsSection" class="transactions-card">
                    <div class="section-header">
                        <h3 class="section-title">Riwayat Transaksi Keuangan</h3>
                    </div>
                    <div id="transactionsTable">
                        <!-- Table or empty state for transactions will be rendered here by JavaScript -->
                    </div>
                    <div id="paginationControls" class="pagination-controls">
                        <!-- Pagination buttons will be rendered here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="addDoctorModal" class="modal">
        <div class="modal-content">
            <h3><i data-feather="user-plus"></i>Tambah Dokter Baru</h3>
            <div class="form-group">
                <label for="newDoctorName">Nama Lengkap Dokter</label>
                <input type="text" id="newDoctorName" placeholder="Contoh: Dr. Ayu Lestari" oninput="checkDoctorName()">
                <small id="nameHint" style="font-size: 0.8rem; display: none; margin-top: 5px;"></small>
            </div>
            <div class="form-group">
                <label for="initialDeposit">Deposit Awal (Opsional)</label>
                <div class="input-with-icon">
                    <input type="text" id="initialDeposit" placeholder="Contoh: 500.000"
                        oninput="formatAmountInput(this)">
                    <i data-feather="grid" class="calculator-trigger-icon"
                        onclick="showCalculatorModal('initialDeposit')"></i>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-outline" onclick="closeModal('addDoctorModal')">Batal</button>
                <button class="btn btn-primary" onclick="addDoctor()">Simpan Dokter</button>
            </div>
        </div>
    </div>

    <div id="addDepositModal" class="modal">
        <div class="modal-content">
            <h3><i data-feather="dollar-sign"></i>Tambah Dana Deposit</h3>
            <div class="form-group">
                <label for="depositDesc">Keterangan Deposit</label>
                <input type="text" id="depositDesc" placeholder="Contoh: Deposit rutin bulanan">
            </div>
            <div class="form-group">
                <label for="additionalDeposit">Jumlah Deposit (Rp)</label>
                <div class="input-with-icon">
                    <input type="text" id="additionalDeposit" placeholder="Contoh: 200.000"
                        oninput="formatAmountInput(this)">
                    <i data-feather="grid" class="calculator-trigger-icon"
                        onclick="showCalculatorModal('additionalDeposit')"></i>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-outline" onclick="closeModal('addDepositModal')">Batal</button>
                <button class="btn btn-success" onclick="addDeposit()">Tambah Deposit</button>
            </div>
        </div>
    </div>

    <!-- Add Expense Modal -->
    <div id="addExpenseModal" class="modal">
        <div class="modal-content">
            <h3><i data-feather="minus-circle"></i>Tambah Pengeluaran Baru</h3>
            <form id="addExpenseForm">
                <div class="form-group">
                    <label for="expenseDateModal">Tanggal Pengeluaran</label>
                    <input type="date" id="expenseDateModal" required>
                </div>
                <div class="form-group">
                    <label for="expenseDescModal">Keterangan</label>
                    <input type="text" id="expenseDescModal" placeholder="Contoh: Pembelian alat tulis" required>
                </div>
                <div class="form-group">
                    <label for="expenseAmountModal">Nominal (Rp)</label>
                    <div class="input-with-icon">
                        <input type="text" id="expenseAmountModal" placeholder="Contoh: 50.000" required
                            oninput="formatAmountInput(this)">
                        <i data-feather="grid" class="calculator-trigger-icon"
                            onclick="showCalculatorModal('expenseAmountModal')"></i>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-outline" onclick="closeModal('addExpenseModal')">Batal</button>
                    <button type="submit" class="btn btn-primary">
                        <i data-feather="plus"></i> Simpan Pengeluaran
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div id="editTransactionModal" class="modal">
        <div class="modal-content">
            <h3><i data-feather="edit"></i>Edit Transaksi</h3>
            <form id="editTransactionForm">
                <input type="hidden" id="editTransactionId">
                <div class="form-group">
                    <label for="editTransactionType">Jenis Transaksi</label>
                    <select id="editTransactionType" class="form-group input" disabled>
                        <option value="expense">Pengeluaran</option>
                        <option value="income">Pemasukan</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editTransactionDate">Tanggal</label>
                    <input type="date" id="editTransactionDate" required>
                </div>
                <div class="form-group">
                    <label for="editTransactionDesc">Keterangan</label>
                    <input type="text" id="editTransactionDesc" required>
                </div>
                <div class="form-group">
                    <label for="editTransactionAmount">Nominal (Rp)</label>
                    <div class="input-with-icon">
                        <input type="text" id="editTransactionAmount" required oninput="formatAmountInput(this)">
                        <i data-feather="grid" class="calculator-trigger-icon"
                            onclick="showCalculatorModal('editTransactionAmount')"></i>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-outline"
                        onclick="closeModal('editTransactionModal')">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirmDeleteModal" class="modal">
        <div class="modal-content">
            <h3><i data-feather="alert-triangle" style="color: var(--red);"></i>Konfirmasi Hapus Transaksi</h3>
            <p>Anda yakin ingin menghapus transaksi ini secara permanen? Tindakan ini tidak dapat diurungkan.</p>
            <div class="modal-buttons">
                <button class="btn btn-outline" onclick="closeModal('confirmDeleteModal')">Batal</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Ya, Hapus Transaksi</button>
            </div>
        </div>
    </div>

    <div id="confirmDeleteDoctorModal" class="modal">
        <div class="modal-content">
            <h3><i data-feather="alert-triangle" style="color: var(--red);"></i>Konfirmasi Hapus Dokter</h3>
            <p id="deleteDoctorText">Yakin ingin menghapus dokter ini beserta semua data transaksinya? Tindakan ini
                tidak dapat diurungkan.</p>
            <div class="modal-buttons">
                <button class="btn btn-outline" onclick="closeModal('confirmDeleteDoctorModal')">Batal</button>
                <button class="btn btn-danger" onclick="confirmDeleteDoctor()">Ya, Hapus Dokter</button>
            </div>
        </div>
    </div>

    <div id="exportPDFModal" class="modal">
        <div class="modal-content">
            <h3><i data-feather="settings"></i>Pengaturan Export Laporan PDF</h3>
            <div class="form-group">
                <label for="exportType">Pilih Data untuk Diexport:</label>
                <select id="exportType" class="form-group input"> <!-- Ensure class is applied -->
                    <option value="all">Semua Transaksi Dokter Ini</option>
                    <option value="range">Transaksi Berdasarkan Rentang Tanggal</option>
                </select>
            </div>
            <div id="dateRangeGroup" style="display: none;">
                <div class="form-group">
                    <label for="exportFromDate">Dari Tanggal:</label>
                    <input type="date" id="exportFromDate" class="form-group input">
                </div>
                <div class="form-group">
                    <label for="exportToDate">Sampai Tanggal:</label>
                    <input type="date" id="exportToDate" class="form-group input">
                </div>
            </div>
            <div class="form-group">
                <label for="exportSort">Urutkan Berdasarkan:</label>
                <select id="exportSort" class="form-group input">
                    <option value="newest">Transaksi Terbaru Dulu</option>
                    <option value="oldest">Transaksi Terlama Dulu</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-outline" onclick="closeModal('exportPDFModal')">Batal</button>
                <button class="btn btn-primary" onclick="processExportToPDF()">
                    <i data-feather="download"></i> Export ke PDF
                </button>
            </div>
        </div>
    </div>

    <!-- Calculator Modal -->
    <div id="calculatorModal" class="modal">
        <div class="modal-content calculator-content">
            <h3><i data-feather="calculator"></i> Kalkulator</h3>
            <div class="calculator-display-container">
                <input type="text" id="calculatorDisplay" readonly>
            </div>
            <div class="calculator-buttons">
                <button onclick="appendToCalculatorDisplay('7')">7</button>
                <button onclick="appendToCalculatorDisplay('8')">8</button>
                <button onclick="appendToCalculatorDisplay('9')">9</button>
                <button class="operator" onclick="appendToCalculatorDisplay('/')">÷</button>

                <button onclick="appendToCalculatorDisplay('4')">4</button>
                <button onclick="appendToCalculatorDisplay('5')">5</button>
                <button onclick="appendToCalculatorDisplay('6')">6</button>
                <button class="operator" onclick="appendToCalculatorDisplay('*')">×</button>

                <button onclick="appendToCalculatorDisplay('1')">1</button>
                <button onclick="appendToCalculatorDisplay('2')">2</button>
                <button onclick="appendToCalculatorDisplay('3')">3</button>
                <button class="operator" onclick="appendToCalculatorDisplay('-')">−</button>

                <button onclick="appendToCalculatorDisplay('0')">0</button>
                <button onclick="appendToCalculatorDisplay('.')">.</button>
                <button class="operator danger" onclick="clearCalculatorDisplay()">C</button>
                <button class="operator" onclick="appendToCalculatorDisplay('+')">+</button>

                <button class="span-2" onclick="calculateResult()">=</button>
                <button class="span-2 primary" onclick="applyCalculatorResult()">OK</button>
            </div>
            <div class="modal-buttons" style="margin-top: 15px;">
                <button type="button" class="btn btn-outline" style="width:100%"
                    onclick="closeModal('calculatorModal')">Tutup Kalkulator</button>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notification" class="notification"></div>

    <!-- Connection Status Indicator -->
    <div id="connectionStatus" class="connection-status online">
        <i data-feather="wifi" style="width: 16px; height: 16px;"></i>
        <span id="statusText">Online</span>
    </div>

    <script>
        // ===================================================================================
        // JAVASCRIPT LOGIC
        // ===================================================================================

        // ===== FIREBASE CONFIGURATION =====
        let firebaseAvailable = false;
        let auth, db;
        // Flag to ensure initial auto-sign-in logic runs only once
        let initialAuthAttempted = false;


        function initializeFirebase() {
            if (typeof firebase !== 'undefined') {
                console.log('✅ Firebase SDK loaded successfully');
                firebaseAvailable = true;

                let effectiveFirebaseConfig;

                // Try to use Canvas-provided config first
                if (typeof __firebase_config !== 'undefined' && __firebase_config.trim() !== "" && __firebase_config !== "YOUR_FIREBASE_CONFIG_JSON_STRING") {
                    try {
                        effectiveFirebaseConfig = JSON.parse(__firebase_config);
                        console.log('🔧 Using Firebase config provided by Canvas environment.');
                    } catch (e) {
                        console.error('Error parsing __firebase_config. Falling back to manual config.', e);
                        // Fallback to user's hardcoded config if __firebase_config is malformed
                        effectiveFirebaseConfig = {
                            apiKey: "AIzaSyCDDmHhlwcjgBArmvXiaTnjgKqGHIi3DHc",
                            authDomain: "wmproject-9269a.firebaseapp.com",
                            projectId: "wmproject-9269a",
                            storageBucket: "wmproject-9269a.firebasestorage.app",
                            messagingSenderId: "706043186227",
                            appId: "1:706043186227:web:470bfa89aa78c68829e746",
                            measurementId: "G-FW9JLPDVJS"
                        };
                        console.warn('🔧 Using manual Firebase config as fallback due to __firebase_config parse error.');
                    }
                } else {
                    // Fallback to user's hardcoded config if __firebase_config is not defined or is placeholder
                    effectiveFirebaseConfig = {
                        apiKey: "AIzaSyCDDmHhlwcjgBArmvXiaTnjgKqGHIi3DHc",
                        authDomain: "wmproject-9269a.firebaseapp.com",
                        projectId: "wmproject-9269a",
                        storageBucket: "wmproject-9269a.firebasestorage.app",
                        messagingSenderId: "706043186227",
                        appId: "1:706043186227:web:470bfa89aa78c68829e746",
                        measurementId: "G-FW9JLPDVJS"
                    };
                    if (typeof __firebase_config === 'undefined') {
                        console.warn('🔧 __firebase_config not found. Using manual Firebase config placeholders. Please replace them with your actual Firebase project details.');
                    } else {
                        console.warn('🔧 __firebase_config seems to be a placeholder. Using manual Firebase config placeholders. Please replace them with your actual Firebase project details.');
                    }
                }


                try {
                    // Check if Firebase app already initialized to prevent re-initialization error
                    if (!firebase.apps.length) {
                        firebase.initializeApp(effectiveFirebaseConfig);
                    } else {
                        firebase.app(); // if already initialized, use that one
                    }
                    auth = firebase.auth();
                    db = firebase.firestore();
                    // Attempt to enable persistence, log errors if any.
                    db.enablePersistence({ synchronizeTabs: true }) // synchronizeTabs can help in multi-tab scenarios
                        .then(() => console.log("Offline persistence enabled."))
                        .catch((err) => {
                            if (err.code == 'failed-precondition') {
                                console.warn('Offline persistence failed: Multiple tabs open or other issues. Persistence can only be enabled in one tab at a time.');
                            } else if (err.code == 'unimplemented') {
                                console.warn('Offline persistence failed: The current browser does not support all of the features required to enable persistence.');
                            } else {
                                console.warn('Offline persistence error:', err.code, err.message);
                            }
                        });
                    console.log('🔥 Firebase initialized successfully with project ID:', effectiveFirebaseConfig.projectId);
                } catch (error) {
                    console.error('Firebase initialization error:', error);
                    firebaseAvailable = false;
                }
            } else {
                console.log('⚠️ Firebase SDK not available, using development mode');
                firebaseAvailable = false;
            }
        }

        // ===== GLOBAL VARIABLES =====
        let currentUser = null;
        let doctors = [];
        let currentDoctorId = null;
        let deleteTransactionId = null;
        let currentEditingTransactionId = null; // For editing transactions
        let isOnline = navigator.onLine;
        let currentTransactionPage = 1;
        const transactionsPerPage = 10;
        let calculatorTargetInputId = null; // To store the ID of the input field for the calculator


        // ===== CONNECTION STATUS UI =====
        function updateConnectionStatus() {
            const statusEl = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            const statusIcon = statusEl.querySelector('i');

            if (!navigator.onLine) {
                statusEl.className = 'connection-status offline';
                statusText.textContent = 'Offline';
                isOnline = false;
                if (statusIcon) statusIcon.setAttribute('data-feather', 'wifi-off');
            } else {
                statusEl.className = 'connection-status online';
                statusText.textContent = 'Online';
                isOnline = true;
                if (statusIcon) statusIcon.setAttribute('data-feather', 'wifi');
            }
            if (typeof feather !== 'undefined') feather.replace();
        }

        function showSyncStatus() {
            const statusEl = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            const statusIcon = statusEl.querySelector('i');

            statusEl.className = 'connection-status syncing';
            statusText.textContent = 'Sinkronisasi...';
            if (statusIcon) statusIcon.setAttribute('data-feather', 'refresh-cw');
            if (typeof feather !== 'undefined') feather.replace();

            setTimeout(() => {
                updateConnectionStatus();
            }, 2000);
        }

        window.addEventListener('online', updateConnectionStatus);
        window.addEventListener('offline', updateConnectionStatus);

        // ===== AUTHENTICATION LOGIC =====
        async function initAuth() {
            if (!firebaseAvailable || !auth) {
                console.warn("Firebase auth is not available. Bypassing to dev mode.");
                bypassLoginForDevelopment();
                hideLoadingScreen();
                return;
            }

            const currentApiKey = auth.app.options.apiKey;
            // Check if using placeholder and no Canvas config
            if (currentApiKey === "YOUR_API_KEY" && typeof __firebase_config === 'undefined') {
                console.warn("Firebase using hardcoded placeholder API key and no Canvas config. Ensure your Firebase config is correct if not using Canvas environment variables. Bypassing to dev mode.");
                bypassLoginForDevelopment();
                hideLoadingScreen();
                return;
            }


            auth.onAuthStateChanged(async (user) => {
                console.log('Auth state changed. User:', user ? user.uid : null, 'Is Anonymous:', user ? user.isAnonymous : 'N/A');

                if (user) {
                    currentUser = user;
                    initialAuthAttempted = true;
                    showMainApp();
                    await loadUserData();
                    hideLoadingScreen();
                } else {
                    if (!initialAuthAttempted) {
                        initialAuthAttempted = true;
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token && __initial_auth_token.trim() !== "") {
                                console.log('Attempting sign-in with custom token...');
                                await auth.signInWithCustomToken(__initial_auth_token);
                                console.log('Custom token sign-in initiated. onAuthStateChanged will handle the new user state.');
                            } else {
                                console.log('No custom token, or Canvas environment not providing one. Attempting anonymous sign-in...');
                                await auth.signInAnonymously();
                                console.log('Anonymous sign-in initiated. onAuthStateChanged will handle the new user state.');
                            }
                        } catch (error) {
                            console.error('Error during initial auto-sign-in (custom/anonymous):', error);
                            let specificErrorMsg = 'Gagal memulai sesi otomatis. Beberapa fitur mungkin tidak berfungsi normal.';
                            if (error.code === 'auth/custom-token-mismatch') {
                                specificErrorMsg = 'Gagal memulai sesi: Token tidak cocok dengan proyek Firebase. Pastikan konfigurasi Firebase (apiKey, projectId, dll.) sesuai dengan token yang digunakan.';
                                console.warn('Custom token audience (project) might not match the Firebase project initialized by the SDK. Effective project ID:', auth.app.options.projectId);
                            } else if (error.code === 'auth/invalid-custom-token') {
                                specificErrorMsg = 'Gagal memulai sesi: Format token kustom tidak valid.';
                            }
                            showNotification(specificErrorMsg, 'error');
                            currentUser = null;
                            showLoginScreen();
                            hideLoadingScreen();
                        }
                    } else {
                        console.log('User signed out or no user after initial auth attempts.');
                        currentUser = null;
                        showLoginScreen();
                        hideLoadingScreen();
                    }
                }
            });
        }

        function bypassLoginForDevelopment() {
            console.log('🔧 DEVELOPMENT MODE: Bypassing Firebase login');
            currentUser = {
                uid: 'dev-user-123',
                email: 'developer@example.com',
                displayName: 'Developer Mode',
                photoURL: `https://ui-avatars.com/api/?name=Dev&background=4f46e5&color=fff&bold=true`
            };
            doctors = [];
            showMainApp();
            loadDoctors();
            showNotification('🔧 Mode Development Aktif. Data tidak disimpan ke Firebase.', 'info');
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        }

        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'flex';
            if (currentUser) {
                document.getElementById('userAvatar').src = currentUser.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.displayName || currentUser.email || 'User')}&background=e2e8f0&color=1e293b&bold=true`;
                document.getElementById('userAvatar').alt = currentUser.displayName || currentUser.email || 'User Avatar';
            }
        }

        function hideLoadingScreen() {
            document.getElementById('loadingScreen').style.display = 'none';
        }

        async function signInWithGoogle() {
            if (!firebaseAvailable || !auth) {
                showNotification('❌ Konfigurasi Firebase tidak ditemukan.', 'error');
                return;
            }
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await auth.signInWithPopup(provider);
                showNotification(`✅ Login Google berhasil! Selamat datang, ${result.user.displayName || result.user.email}!`, 'success');
            } catch (error) {
                console.error('Google Login error:', error);
                if (error.code === 'auth/operation-not-supported-in-this-environment') {
                    showNotification('❌ Login Google via popup tidak didukung di lingkungan ini. Coba buka aplikasi di tab browser biasa atau pastikan web storage aktif.', 'error');
                } else if (error.code === 'auth/popup-closed-by-user') {
                    showNotification('ℹ️ Proses login Google dibatalkan oleh pengguna.', 'info');
                } else if (error.code === 'auth/cancelled-popup-request') {
                    showNotification('ℹ️ Permintaan login Google sebelumnya masih aktif atau dibatalkan. Silakan coba lagi.', 'info');
                }
                else {
                    showNotification('❌ Login Google gagal: ' + error.message, 'error');
                }
            }
        }

        async function signOut() {
            if (!firebaseAvailable || !auth || (currentUser && currentUser.uid === 'dev-user-123')) {
                currentUser = null;
                initialAuthAttempted = false;
                showLoginScreen();
                showNotification('ℹ️ Anda telah keluar dari mode development.', 'info');
                return;
            }
            try {
                await auth.signOut();
                showNotification('ℹ️ Anda telah berhasil keluar.', 'info');
                currentDoctorId = null;
                doctors = [];
                loadDoctors();
                selectDoctor(null);
                initialAuthAttempted = false;
            } catch (error) {
                showNotification('❌ Gagal keluar: ' + error.message, 'error');
            }
        }

        // ===== FIRESTORE DATA OPERATIONS =====
        async function loadUserData() {
            if (!currentUser || !currentUser.uid) {
                console.warn("loadUserData called but currentUser or currentUser.uid is not available. Current user:", currentUser);
                selectDoctor(null);
                return;
            }
            if (!firebaseAvailable && currentUser.uid === 'dev-user-123') {
                console.log('🔧 Dev mode: Using in-memory data for doctors.');
                loadDoctors();
                if (doctors.length > 0) {
                    selectDoctor(doctors[0].id);
                } else {
                    selectDoctor(null);
                }
                return;
            }

            if (!db) {
                console.error("Firestore database instance (db) is not available.");
                showNotification("❌ Database tidak tersedia. Tidak dapat memuat data.", "error");
                return;
            }

            try {
                showSyncStatus();
                console.log(`Attempting to load data for UID: ${currentUser.uid}, Is Anonymous: ${currentUser.isAnonymous}. Project ID: ${auth.app.options.projectId}`);
                const userDocRef = db.collection('users').doc(currentUser.uid);
                const docSnapshot = await userDocRef.get();
                if (docSnapshot.exists) {
                    doctors = docSnapshot.data().doctors || [];
                    console.log(`Data loaded for UID: ${currentUser.uid}. Number of doctors: ${doctors.length}`);
                } else {
                    doctors = [];
                    console.log(`No data found for UID: ${currentUser.uid}. Initializing with empty doctors list.`);
                    if (!currentUser.isAnonymous) {
                        showNotification('🎉 Selamat datang! Silakan tambahkan dokter pertama Anda.', 'success');
                    } else {
                        console.log("New anonymous session, no existing data to load, this is expected.");
                    }
                }
                loadDoctors();
                if (doctors.length > 0) {
                    selectDoctor(doctors[0].id);
                } else {
                    selectDoctor(null);
                }
            } catch (error) {
                console.error(`Error loading user data from Firestore for UID: ${currentUser.uid} on Project ID: ${auth.app.options.projectId}:`, error);
                let errorMsg = '❌ Gagal memuat data pengguna dari cloud.';
                if (error.code === 'permission-denied' || (error.message && error.message.toLowerCase().includes("missing or insufficient permissions"))) {
                    errorMsg = `❌ Gagal memuat data: Izin ditolak untuk UID ${currentUser.uid} pada proyek ${auth.app.options.projectId}. Pastikan aturan keamanan Firestore Anda mengizinkan akses.`;
                    console.error("Firestore permission error details:", error.details || "No details provided by Firebase error object.");
                } else {
                    errorMsg += ` (${error.message || error.code || 'Unknown error'})`;
                }
                showNotification(errorMsg, 'error');
                doctors = [];
                loadDoctors();
                selectDoctor(null);
            }
        }

        async function saveUserData() {
            if (!currentUser || !currentUser.uid) {
                console.warn("saveUserData called but currentUser or currentUser.uid is not available. Current user:", currentUser);
                showNotification("Tidak dapat menyimpan data: Sesi pengguna tidak valid.", "error");
                return;
            }
            if (!firebaseAvailable && currentUser.uid === 'dev-user-123') {
                console.log('🔧 Dev mode or no user: Skipping Firebase save.');
                return;
            }
            if (!db) {
                console.error("Firestore database instance (db) is not available for saving.");
                showNotification("❌ Database tidak tersedia. Tidak dapat menyimpan data.", "error");
                return;
            }
            try {
                showSyncStatus();
                console.log(`Attempting to save data for UID: ${currentUser.uid} on Project ID: ${auth.app.options.projectId}`);
                const userDocRef = db.collection('users').doc(currentUser.uid);
                const now = new Date();
                doctors.forEach(doctor => {
                    doctor.updatedAt = now.toISOString();
                    if (!doctor.createdAt) {
                        doctor.createdAt = now.toISOString();
                    }
                });
                await userDocRef.set({ doctors: doctors, lastUpdated: now.toISOString() }, { merge: true });
                console.log('Data saved successfully to Firebase.');
            } catch (error) {
                console.error(`Error saving data to Firestore for UID: ${currentUser.uid} on Project ID: ${auth.app.options.projectId}:`, error);
                let errorMsg = '⚠️ Gagal menyimpan data ke cloud.';
                if (error.code === 'permission-denied' || (error.message && error.message.toLowerCase().includes("missing or insufficient permissions"))) {
                    errorMsg = `❌ Gagal menyimpan data: Izin ditolak untuk UID ${currentUser.uid} pada proyek ${auth.app.options.projectId}. Pastikan aturan keamanan Firestore Anda mengizinkan penulisan.`;
                } else {
                    errorMsg += ` (${error.message || error.code || 'Unknown error'})`;
                }
                showNotification(errorMsg, 'error');
            }
        }

        // ===== UI UTILITY FUNCTIONS =====
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification ' + type;
            notification.classList.add('show');
            setTimeout(() => { notification.classList.remove('show'); }, 5000); // Longer display for errors
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(amount);
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('id-ID').format(num);
        }

        function unformatNumber(str) {
            return parseInt(String(str).replace(/\./g, '').replace(/,/g, '')) || 0;
        }

        function formatAmountInput(inputElement) {
            let value = inputElement.value;
            let unformattedValue = value.replace(/\D/g, '');

            if (unformattedValue) {
                let numberValue = parseInt(unformattedValue, 10);
                inputElement.value = formatNumber(numberValue);
            } else {
                inputElement.value = '';
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                // Ensure the date string is in a format that Date constructor can parse reliably, e.g.,<y_bin_46>-MM-DD
                const parts = dateString.split('-');
                if (parts.length === 3) {
                    // Assuming<y_bin_46>-MM-DD or similar that Date can parse
                    return new Date(dateString).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
                }
                // If not in expected format, try parsing directly (might be less reliable)
                return new Date(dateString).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });

            } catch (e) {
                console.warn("Error formatting date:", dateString, e);
                return dateString;
            }
        }

        function setTodayDate(elementId) {
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById(elementId);
            if (dateInput) dateInput.value = today;
        }

        // ===== DOCTOR MANAGEMENT (ADAPTED FOR NEW UI) =====
        function loadDoctors() {
            const listElement = document.getElementById('doctorList');
            listElement.innerHTML = '';

            if (doctors.length === 0) {
                listElement.innerHTML = `
                    <li class="doctor-list-empty-state">
                        <i data-feather="users"></i>
                        <span>Belum ada dokter terdaftar.<br>Silakan tambahkan dokter baru.</span>
                    </li>`;
                if (typeof feather !== 'undefined') feather.replace();
                return;
            }

            doctors.forEach(doctor => {
                const li = document.createElement('li');
                li.setAttribute('data-id', doctor.id);
                li.onclick = () => {
                    selectDoctor(doctor.id);
                    closeDrawer(); // Close drawer after selecting a doctor on mobile
                }
                li.innerHTML = `<i data-feather="user"></i> <span class="doctor-name-sidebar">${doctor.name}</span>`;
                listElement.appendChild(li);
            });
            if (typeof feather !== 'undefined') feather.replace();
        }

        function selectDoctor(doctorId) {
            currentDoctorId = doctorId;
            currentTransactionPage = 1; // Reset to first page when selecting a new doctor
            const doctor = doctors.find(d => d.id == doctorId);
            const deleteDoctorButton = document.getElementById('deleteDoctorBtn');

            document.querySelectorAll('#doctorList li').forEach(li => {
                li.classList.toggle('active', li.getAttribute('data-id') == doctorId);
            });

            const doctorInfoSection = document.getElementById('doctorInfo');
            const noDoctorSelectedSection = document.getElementById('noDoctorSelected');
            const welcomeHeader = document.getElementById('welcomeHeader');
            const welcomeSubheader = document.getElementById('welcomeSubheader');

            if (doctor) {
                welcomeHeader.textContent = `Dasbor Dr. ${doctor.name}`;
                welcomeSubheader.textContent = `Kelola data keuangan untuk Dr. ${doctor.name}.`;

                updateDoctorInfoUI(doctor);
                doctorInfoSection.style.display = 'block';
                noDoctorSelectedSection.style.display = 'none';
                if (deleteDoctorButton) deleteDoctorButton.style.display = 'inline-flex';

                setTodayDate('expenseDateModal'); // Set default date for new expense modal
            } else {
                currentDoctorId = null;
                doctorInfoSection.style.display = 'none';
                noDoctorSelectedSection.style.display = 'block';
                welcomeHeader.textContent = 'Dasbor Utama';
                welcomeSubheader.textContent = 'Selamat datang! Pilih dokter untuk memulai.';
                if (deleteDoctorButton) deleteDoctorButton.style.display = 'none';
                document.getElementById('transactionsTable').innerHTML = ''; // Clear table
                document.getElementById('paginationControls').innerHTML = ''; // Clear pagination
            }
        }

        function updateDoctorInfoUI(doctor) {
            const totalExpense = doctor.transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);

            const totalIncome = doctor.transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);

            doctor.totalDeposit = totalIncome;
            const remainingBalance = doctor.totalDeposit - totalExpense;

            document.getElementById('totalDeposit').textContent = formatCurrency(doctor.totalDeposit);
            document.getElementById('totalExpense').textContent = formatCurrency(totalExpense);
            const remainingBalanceEl = document.getElementById('remainingBalance');
            remainingBalanceEl.textContent = formatCurrency(remainingBalance);
            remainingBalanceEl.className = 'stat-card-value';
            remainingBalanceEl.classList.add(remainingBalance < 0 ? 'negative' : 'positive');

            renderTransactions(doctor.transactions, currentTransactionPage);
        }

        // ===== TRANSACTIONS RENDER (ADAPTED FOR NEW UI) =====
        function renderTransactions(allTransactions, page = 1) {
            const container = document.getElementById('transactionsTable');
            const paginationControls = document.getElementById('paginationControls');
            container.innerHTML = ''; // Clear previous table
            paginationControls.innerHTML = ''; // Clear previous controls

            if (!allTransactions || allTransactions.length === 0) {
                container.innerHTML = `<div class="empty-state" style="padding: 30px;"><i data-feather="info"></i><p>Belum ada transaksi untuk dokter ini.</p></div>`;
                if (typeof feather !== 'undefined') feather.replace();
                return;
            }

            const sortedTransactions = allTransactions.slice().sort((a, b) => new Date(b.date) - new Date(a.date));

            const startIndex = (page - 1) * transactionsPerPage;
            const endIndex = page * transactionsPerPage;
            const paginatedTransactions = sortedTransactions.slice(startIndex, endIndex);


            let tableHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th class="no-column">No.</th>
                                <th>Tanggal</th>
                                <th>Keterangan</th>
                                <th style="text-align: right;">Nominal</th>
                                <th class="actions-column">Tindakan</th>
                            </tr>
                        </thead>
                        <tbody>`;

            paginatedTransactions.forEach((t, index) => {
                const overallIndex = startIndex + index + 1; // Calculate overall number
                const isIncome = t.type === 'income';
                const typeLabel = isIncome ? '(Pemasukan)' : '(Pengeluaran)';
                const descriptionText = `${t.description} <em style="font-size:0.8em; color:${isIncome ? 'var(--green)' : 'var(--red)'};">${typeLabel}</em>`;

                tableHTML += `
                    <tr>
                        <td class="no-column">${overallIndex}</td>
                        <td>${formatDate(t.date)}</td>
                        <td class="description-cell" title="${t.description} ${typeLabel}">${descriptionText}</td>
                        <td class="amount-cell ${isIncome ? 'income-amount' : 'expense-amount'}">
                            ${isIncome ? '+' : '-'} ${formatCurrency(t.amount)}
                        </td>
                        <td class="actions-column-cell">
                            <div class="transaction-actions-wrapper">
                                <button class="btn btn-icon edit-btn" onclick="showEditTransactionModal(${t.id})" title="Edit Transaksi">
                                    <i data-feather="edit-2"></i>
                                </button>
                                <button class="btn btn-icon delete-btn" onclick="showDeleteConfirm(${t.id})" title="Hapus Transaksi">
                                    <i data-feather="trash-2"></i>
                                </button>
                            </div>
                        </td>
                    </tr>`;
            });

            tableHTML += '</tbody></table></div>';
            container.innerHTML = tableHTML;

            renderPaginationControls(allTransactions.length, page);

            if (typeof feather !== 'undefined') feather.replace();
        }

        function renderPaginationControls(totalItems, currentPage) {
            const paginationControls = document.getElementById('paginationControls');
            const totalPages = Math.ceil(totalItems / transactionsPerPage);

            if (totalPages <= 1) {
                paginationControls.innerHTML = ''; // No controls if only one page or less
                return;
            }

            let controlsHTML = '';

            // Previous Button
            controlsHTML += `
                <button class="btn btn-outline btn-sm" onclick="changeTransactionPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                    <i data-feather="chevron-left"></i> Seb
                </button>`;

            // Page Info (e.g., Page 1 of 3)
            controlsHTML += `<span class="page-info">Hal ${currentPage} dari ${totalPages}</span>`;

            // Next Button
            controlsHTML += `
                <button class="btn btn-outline btn-sm" onclick="changeTransactionPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                    Ber <i data-feather="chevron-right"></i>
                </button>`;

            paginationControls.innerHTML = controlsHTML;
            if (typeof feather !== 'undefined') feather.replace();
        }

        function changeTransactionPage(newPage) {
            const doctor = doctors.find(d => d.id == currentDoctorId);
            if (doctor) {
                currentTransactionPage = newPage;
                renderTransactions(doctor.transactions, currentTransactionPage);
            }
        }


        // ===== CORE LOGIC FUNCTIONS (addExpense, addDoctor, etc. - CORE LOGIC UNCHANGED) =====
        async function addExpense() { // Reads from addExpenseModal
            const date = document.getElementById('expenseDateModal').value;
            const description = document.getElementById('expenseDescModal').value.trim();
            const amount = unformatNumber(document.getElementById('expenseAmountModal').value);

            if (!date || !description || !amount || amount <= 0) {
                showNotification('❌ Harap isi semua field pengeluaran dengan benar.', 'error');
                return;
            }

            const doctor = doctors.find(d => d.id == currentDoctorId);
            if (doctor) {
                const newTransaction = {
                    id: Date.now(),
                    date: date,
                    description: description,
                    amount: amount,
                    type: 'expense',
                    createdAt: new Date().toISOString()
                };
                doctor.transactions.push(newTransaction);
                currentTransactionPage = 1; // Go to first page to see new transaction
                await saveUserData();
                updateDoctorInfoUI(doctor);
                closeModal('addExpenseModal');
                document.getElementById('addExpenseForm').reset(); // Reset form in modal
                showNotification('✅ Pengeluaran berhasil dicatat!', 'success');
            } else {
                showNotification('❌ Dokter tidak ditemukan. Tidak dapat menambah pengeluaran.', 'error');
            }
        }

        async function addDoctor() {
            const name = document.getElementById('newDoctorName').value.trim();
            const initialDepositAmount = unformatNumber(document.getElementById('initialDeposit').value);

            if (!name) {
                showNotification('❌ Nama dokter tidak boleh kosong.', 'error');
                document.getElementById('newDoctorName').focus();
                return;
            }
            if (doctors.find(d => d.name.toLowerCase() === name.toLowerCase())) {
                showNotification('❌ Dokter dengan nama ini sudah terdaftar.', 'error');
                document.getElementById('newDoctorName').focus();
                return;
            }

            const newDoctor = {
                id: Date.now(),
                name: name,
                totalDeposit: 0,
                transactions: [],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            if (initialDepositAmount > 0) {
                const initialDepositTransaction = {
                    id: Date.now() + 1,
                    date: new Date().toISOString().split('T')[0],
                    description: 'Deposit Awal',
                    amount: initialDepositAmount,
                    type: 'income',
                    createdAt: new Date().toISOString()
                };
                newDoctor.transactions.push(initialDepositTransaction);
            }

            doctors.push(newDoctor);
            await saveUserData();
            loadDoctors();
            selectDoctor(newDoctor.id);
            closeModal('addDoctorModal');
            showNotification(`✅ Dokter "${name}" berhasil ditambahkan!`, 'success');
            document.getElementById('newDoctorName').value = '';
            document.getElementById('initialDeposit').value = '';
        }

        async function addDeposit() {
            const amount = unformatNumber(document.getElementById('additionalDeposit').value);
            const description = document.getElementById('depositDesc').value.trim() || 'Tambah Deposit Rutin';

            if (!amount || amount <= 0) {
                showNotification('❌ Jumlah deposit tidak valid atau kosong.', 'error');
                document.getElementById('additionalDeposit').focus();
                return;
            }

            const doctor = doctors.find(d => d.id == currentDoctorId);
            if (doctor) {
                const depositTransaction = {
                    id: Date.now(),
                    date: new Date().toISOString().split('T')[0],
                    description: description,
                    amount: amount,
                    type: 'income',
                    createdAt: new Date().toISOString()
                };
                doctor.transactions.push(depositTransaction);
                currentTransactionPage = 1; // Go to first page
                await saveUserData();
                updateDoctorInfoUI(doctor);
                closeModal('addDepositModal');
                document.getElementById('additionalDeposit').value = '';
                document.getElementById('depositDesc').value = '';
                showNotification('✅ Deposit berhasil ditambahkan!', 'success');
            } else {
                showNotification('❌ Dokter tidak ditemukan. Tidak dapat menambah deposit.', 'error');
            }
        }

        async function confirmDelete() {
            const doctor = doctors.find(d => d.id == currentDoctorId);
            if (doctor && deleteTransactionId) {
                const oldTotalTransactions = doctor.transactions.length;
                doctor.transactions = doctor.transactions.filter(t => t.id != deleteTransactionId);
                doctor.updatedAt = new Date().toISOString();

                // Adjust current page if the last item on the last page was deleted
                const newTotalPages = Math.ceil(doctor.transactions.length / transactionsPerPage);
                if (currentTransactionPage > newTotalPages && newTotalPages > 0) {
                    currentTransactionPage = newTotalPages;
                } else if (newTotalPages === 0) {
                    currentTransactionPage = 1;
                }

                await saveUserData();
                updateDoctorInfoUI(doctor); // This will re-render with pagination
                closeModal('confirmDeleteModal');
                showNotification('✅ Transaksi berhasil dihapus.', 'success');
                deleteTransactionId = null;
            }
        }

        async function confirmDeleteDoctor() {
            if (currentDoctorId) {
                const doctorName = doctors.find(d => d.id == currentDoctorId)?.name || "Dokter ini";
                doctors = doctors.filter(d => d.id != currentDoctorId);
                await saveUserData();
                loadDoctors();
                currentDoctorId = null;
                selectDoctor(null);
                closeModal('confirmDeleteDoctorModal');
                showNotification(`✅ ${doctorName} dan semua datanya berhasil dihapus.`, 'success');
                if (doctors.length > 0) {
                    selectDoctor(doctors[0].id);
                }
            }
        }

        // ===== FORM & MODAL UI FUNCTIONS (ADAPTED) =====
        function showAddExpenseModal() {
            document.getElementById('addExpenseForm').reset(); // Clear previous input
            setTodayDate('expenseDateModal'); // Set today's date for the modal input
            document.getElementById('addExpenseModal').classList.add('show');
            document.getElementById('expenseDescModal').focus();
        }

        function checkDoctorName() {
            const nameInput = document.getElementById('newDoctorName');
            const name = nameInput.value.trim();
            const hintElement = document.getElementById('nameHint');

            if (name.length === 0) {
                hintElement.style.display = 'none';
                nameInput.style.borderColor = 'var(--border-color)';
                return;
            }

            const existingDoctor = doctors.find(d => d.name.toLowerCase() === name.toLowerCase());
            if (existingDoctor) {
                hintElement.textContent = 'Nama dokter ini sudah ada. Gunakan nama lain.';
                hintElement.style.color = 'var(--red)';
                nameInput.style.borderColor = 'var(--red)';
            } else {
                hintElement.textContent = 'Nama tersedia ✓';
                hintElement.style.color = 'var(--green)';
                nameInput.style.borderColor = 'var(--green)';
            }
            hintElement.style.display = 'block';
        }

        function showAddDoctorModal() {
            document.getElementById('addDoctorModal').classList.add('show');
            document.getElementById('newDoctorName').value = '';
            document.getElementById('initialDeposit').value = '';
            checkDoctorName();
            document.getElementById('newDoctorName').focus();
        }

        function showAddDepositModal() {
            document.getElementById('additionalDeposit').value = '';
            document.getElementById('depositDesc').value = '';
            document.getElementById('addDepositModal').classList.add('show');
            document.getElementById('additionalDeposit').focus();
        }

        function showDeleteConfirm(transactionId) {
            deleteTransactionId = transactionId;
            document.getElementById('confirmDeleteModal').classList.add('show');
        }

        function showDeleteDoctorModal() {
            const doctor = doctors.find(d => d.id == currentDoctorId);
            if (doctor) {
                document.getElementById('deleteDoctorText').textContent = `Anda yakin ingin menghapus "Dr. ${doctor.name}" beserta seluruh riwayat transaksinya? Tindakan ini tidak dapat diurungkan.`;
                document.getElementById('confirmDeleteDoctorModal').classList.add('show');
            } else {
                showNotification('ℹ️ Tidak ada dokter yang dipilih untuk dihapus.', 'info');
            }
        }

        function showExportModal() {
            const doctor = doctors.find(d => d.id == currentDoctorId);
            if (!doctor) {
                showNotification('❌ Pilih dokter terlebih dahulu untuk export laporan.', 'error');
                return;
            }
            if (!doctor.transactions || doctor.transactions.length === 0) {
                showNotification('ℹ️ Tidak ada transaksi untuk dokter ini yang bisa diexport.', 'error');
                return;
            }
            document.getElementById('exportPDFModal').classList.add('show');
            document.getElementById('exportType').value = 'all';
            document.getElementById('dateRangeGroup').style.display = 'none';
            document.getElementById('exportFromDate').value = '';
            document.getElementById('exportToDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('exportSort').value = 'newest';
            setupExportModalEventListeners();
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.remove('show');
        }

        // ===== EDIT TRANSACTION LOGIC =====
        function showEditTransactionModal(transactionId) {
            currentEditingTransactionId = transactionId;
            const doctor = doctors.find(d => d.id == currentDoctorId);
            if (!doctor) return;

            const transaction = doctor.transactions.find(t => t.id == transactionId);
            if (!transaction) return;

            document.getElementById('editTransactionId').value = transaction.id;
            document.getElementById('editTransactionDate').value = transaction.date;
            document.getElementById('editTransactionDesc').value = transaction.description;
            document.getElementById('editTransactionAmount').value = formatNumber(transaction.amount); // Format for display
            document.getElementById('editTransactionType').value = transaction.type;


            document.getElementById('editTransactionModal').classList.add('show');
            if (typeof feather !== 'undefined') feather.replace();
        }

        async function saveEditedTransaction() {
            const transactionId = currentEditingTransactionId;
            const newDate = document.getElementById('editTransactionDate').value;
            const newDesc = document.getElementById('editTransactionDesc').value.trim();
            const newAmount = unformatNumber(document.getElementById('editTransactionAmount').value);
            // Type is not editable for now, but could be added:
            // const newType = document.getElementById('editTransactionType').value; 

            if (!newDate || !newDesc || !newAmount || newAmount <= 0) {
                showNotification('❌ Harap isi semua field edit dengan benar.', 'error');
                return;
            }

            const doctor = doctors.find(d => d.id == currentDoctorId);
            if (doctor) {
                const transactionIndex = doctor.transactions.findIndex(t => t.id == transactionId);
                if (transactionIndex > -1) {
                    doctor.transactions[transactionIndex].date = newDate;
                    doctor.transactions[transactionIndex].description = newDesc;
                    doctor.transactions[transactionIndex].amount = newAmount;
                    // doctor.transactions[transactionIndex].type = newType; // If type editing is enabled
                    doctor.transactions[transactionIndex].updatedAt = new Date().toISOString();

                    await saveUserData();
                    updateDoctorInfoUI(doctor); // This will re-render with pagination
                    closeModal('editTransactionModal');
                    showNotification('✅ Transaksi berhasil diperbarui!', 'success');
                } else {
                    showNotification('❌ Transaksi tidak ditemukan untuk diedit.', 'error');
                }
            }
            currentEditingTransactionId = null;
        }


        // ===== PDF EXPORT LOGIC =====
        function setupExportModalEventListeners() {
            const exportTypeSelect = document.getElementById('exportType');
            const dateRangeGroup = document.getElementById('dateRangeGroup');
            if (!exportTypeSelect.dataset.listenerAttached) {
                exportTypeSelect.onchange = function () {
                    dateRangeGroup.style.display = this.value === 'range' ? 'block' : 'none';
                    if (this.value === 'range' && !document.getElementById('exportFromDate').value) {
                        const today = new Date();
                        const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
                        document.getElementById('exportFromDate').value = lastMonth.toISOString().split('T')[0];
                        document.getElementById('exportToDate').value = today.toISOString().split('T')[0];
                    }
                };
                exportTypeSelect.dataset.listenerAttached = 'true';
            }
        }

        function processExportToPDF() {
            const doctor = doctors.find(d => d.id == currentDoctorId);
            if (!doctor) {
                showNotification('❌ Dokter tidak ditemukan untuk export.', 'error');
                return;
            }

            const exportType = document.getElementById('exportType').value;
            const exportSort = document.getElementById('exportSort').value;
            const fromDateStr = document.getElementById('exportFromDate').value;
            const toDateStr = document.getElementById('exportToDate').value;

            let transactionsToExport = doctor.transactions.slice();

            if (exportType === 'range') {
                if (!fromDateStr || !toDateStr) {
                    showNotification('❌ Harap pilih rentang tanggal untuk export.', 'error');
                    return;
                }
                const fromDate = new Date(fromDateStr);
                fromDate.setHours(0, 0, 0, 0);
                const toDate = new Date(toDateStr);
                toDate.setHours(23, 59, 59, 999);

                transactionsToExport = transactionsToExport.filter(t => {
                    const transactionDate = new Date(t.date);
                    return transactionDate >= fromDate && transactionDate <= toDate;
                });

                if (transactionsToExport.length === 0) {
                    showNotification('ℹ️ Tidak ada transaksi ditemukan dalam rentang tanggal yang dipilih.', 'info');
                    return;
                }
            }

            transactionsToExport.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return exportSort === 'newest' ? dateB - dateA : dateA - dateB;
            });

            try {
                const { jsPDF } = window.jspdf;
                if (!jsPDF) {
                    showNotification('❌ Library PDF (jsPDF) tidak ditemukan.', 'error');
                    return;
                }
                const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });

                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text(`Laporan Keuangan - Dr. ${doctor.name}`, 14, 20);

                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Dicetak oleh: ${(currentUser && currentUser.displayName) || (currentUser && currentUser.email) || 'Pengguna Aplikasi'}`, 14, 26);
                doc.text(`Tanggal Cetak: ${new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`, 14, 32);

                let currentY = 40;
                if (exportType === 'range') {
                    doc.text(`Periode Laporan: ${formatDate(fromDateStr)} s/d ${formatDate(toDateStr)}`, 14, currentY);
                    currentY += 8;
                }

                const totalExpenseForPeriod = transactionsToExport
                    .filter(t => t.type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);
                const overallTotalDeposit = doctor.transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const overallTotalExpense = doctor.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                const overallRemainingBalance = overallTotalDeposit - overallTotalExpense;

                // Data for summary table
                const summaryBody = [
                    ['Total Deposit Keseluruhan (Dr. ' + doctor.name + ')', formatCurrency(overallTotalDeposit)],
                    ['Total Pengeluaran (Periode Laporan Ini)', formatCurrency(totalExpenseForPeriod)],
                ];

                // Add Sisa Saldo with conditional styling
                const sisaSaldoText = formatCurrency(overallRemainingBalance);
                const sisaSaldoStyle = {
                    content: sisaSaldoText,
                    styles: {
                        halign: 'right',
                        fillColor: overallRemainingBalance < 0 ? [239, 68, 68] : [16, 185, 129], // Red or Green
                        textColor: [255, 255, 255] // White text
                    }
                };
                summaryBody.push(['Sisa Saldo Keseluruhan (Dr. ' + doctor.name + ')', sisaSaldoStyle]);


                doc.autoTable({
                    startY: currentY,
                    head: [['Deskripsi Ringkasan', 'Jumlah']],
                    body: summaryBody,
                    theme: 'grid',
                    headStyles: { fillColor: [79, 70, 229] },
                    columnStyles: { 1: { halign: 'right' } }, // Align amount to the right
                    margin: { top: 10 }
                });
                currentY = doc.lastAutoTable.finalY + 10;

                if (transactionsToExport.length > 0) {
                    doc.autoTable({
                        startY: currentY,
                        head: [['No.', 'Tanggal', 'Keterangan', 'Jenis', 'Nominal (Rp)']],
                        body: transactionsToExport.map((t, index) => [
                            index + 1,
                            formatDate(t.date),
                            t.description,
                            t.type === 'income' ? 'Pemasukan' : 'Pengeluaran',
                            { content: formatCurrency(t.amount), styles: { halign: 'right' } }
                        ]),
                        theme: 'striped',
                        headStyles: { fillColor: [79, 70, 229] },
                        columnStyles: {
                            0: { cellWidth: 10 },
                            1: { cellWidth: 25 },
                            2: { cellWidth: 'auto' },
                            3: { cellWidth: 25 },
                            4: { cellWidth: 30, halign: 'right' }
                        },
                        didParseCell: function (data) {
                            if (data.row.section === 'body' && data.column.dataKey === 3) {
                                if (data.cell.raw === 'Pemasukan') {
                                    data.cell.styles.textColor = [16, 185, 129];
                                } else if (data.cell.raw === 'Pengeluaran') {
                                    data.cell.styles.textColor = [239, 68, 68];
                                }
                            }
                        }
                    });
                } else {
                    doc.text('Tidak ada transaksi untuk ditampilkan dalam periode ini.', 14, currentY);
                }

                let filename = `Laporan_${doctor.name.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(filename);
                showNotification('✅ Laporan PDF berhasil diexport!', 'success');
            } catch (error) {
                console.error('Kesalahan saat export PDF:', error);
                showNotification('❌ Gagal export PDF: ' + error.message, 'error');
            }
            closeModal('exportPDFModal');
        }

        // ===== CALCULATOR LOGIC =====
        let calculatorCurrentExpression = '';

        function showCalculatorModal(targetId) {
            calculatorTargetInputId = targetId;
            document.getElementById('calculatorDisplay').value = ''; // Clear display
            calculatorCurrentExpression = ''; // Clear expression
            document.getElementById('calculatorModal').classList.add('show');
            if (typeof feather !== 'undefined') feather.replace();
        }

        function appendToCalculatorDisplay(value) {
            const display = document.getElementById('calculatorDisplay');
            // Prevent multiple operators or leading operator (except minus)
            const lastChar = calculatorCurrentExpression.slice(-1);
            const operators = ['/', '*', '-', '+'];
            if (operators.includes(value) && operators.includes(lastChar)) {
                // Replace last operator if new one is different, or ignore if same
                if (value !== lastChar) {
                    calculatorCurrentExpression = calculatorCurrentExpression.slice(0, -1) + value;
                }
            } else if (operators.includes(value) && calculatorCurrentExpression === '' && value !== '-') {
                // Prevent leading operator other than minus
                return;
            }
            else {
                calculatorCurrentExpression += value;
            }
            display.value = calculatorCurrentExpression;
        }

        function clearCalculatorDisplay() {
            calculatorCurrentExpression = '';
            document.getElementById('calculatorDisplay').value = '';
        }

        function calculateResult() {
            const display = document.getElementById('calculatorDisplay');
            try {
                // Basic sanitization: remove anything not a digit, operator, or decimal point.
                let sanitizedExpression = calculatorCurrentExpression.replace(/[^-()\d/*+.]/g, '');
                if (sanitizedExpression === '') {
                    display.value = '0';
                    calculatorCurrentExpression = '0';
                    return;
                }
                // Using Function constructor for safer evaluation than direct eval()
                let result = new Function('return ' + sanitizedExpression)();
                if (isNaN(result) || !isFinite(result)) {
                    throw new Error("Invalid calculation");
                }
                display.value = result;
                calculatorCurrentExpression = result.toString();
            } catch (error) {
                display.value = 'Error';
                calculatorCurrentExpression = '';
                console.error("Calculator error:", error);
            }
        }

        function applyCalculatorResult() {
            const display = document.getElementById('calculatorDisplay');
            // Ensure calculation is done if user presses OK without pressing =
            if (calculatorCurrentExpression !== display.value) { // If display was manually changed or = was not pressed
                calculateResult(); // Calculate first
                if (display.value === 'Error') { // If calculation resulted in error
                    showNotification("Hasil kalkulator tidak valid.", "error");
                    return;
                }
            }

            const result = parseFloat(display.value);
            if (!isNaN(result) && calculatorTargetInputId) {
                const targetInput = document.getElementById(calculatorTargetInputId);
                if (targetInput) {
                    targetInput.value = result; // Set raw number
                    formatAmountInput(targetInput); // Then format it
                }
            }
            closeModal('calculatorModal');
        }


        // ===== DRAWER/SIDEBAR TOGGLE LOGIC =====
        function toggleDrawer() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mainContentOverlay');
            const body = document.body;
            sidebar.classList.toggle('open');
            body.classList.toggle('drawer-open');
            if (overlay) { // Check if overlay exists
                overlay.style.display = sidebar.classList.contains('open') ? 'block' : 'none';
            }
        }

        function closeDrawer() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mainContentOverlay');
            const body = document.body;
            sidebar.classList.remove('open');
            body.classList.remove('drawer-open');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }


        // ===== EVENT LISTENERS SETUP =====
        function setupEventListeners() {
            document.getElementById('googleLoginBtn').onclick = signInWithGoogle;
            // Desktop logout button
            const logoutBtnDesktop = document.getElementById('logoutBtnDesktop');
            if (logoutBtnDesktop) logoutBtnDesktop.onclick = signOut;
            // Sidebar (drawer) logout button
            const logoutBtnSidebar = document.getElementById('logoutBtnSidebar');
            if (logoutBtnSidebar) logoutBtnSidebar.onclick = () => {
                signOut();
                closeDrawer(); // Close drawer after logout
            };

            // Changed from toggleExpenseBtn to addExpenseModalBtn
            const addExpenseModalButton = document.getElementById('addExpenseModalBtn');
            if (addExpenseModalButton) addExpenseModalButton.onclick = showAddExpenseModal;

            document.getElementById('addExpenseForm').onsubmit = e => { e.preventDefault(); addExpense(); };
            document.getElementById('editTransactionForm').onsubmit = e => { e.preventDefault(); saveEditedTransaction(); };

            // Hamburger button to toggle drawer
            const hamburgerBtn = document.getElementById('hamburgerBtn');
            if (hamburgerBtn) hamburgerBtn.onclick = toggleDrawer;

            // Overlay click to close drawer
            const overlay = document.getElementById('mainContentOverlay');
            if (overlay) overlay.onclick = closeDrawer;


            window.addEventListener('click', function (event) {
                document.querySelectorAll('.modal.show').forEach(modal => {
                    // Close modal only if the click is on the backdrop itself, not on its content
                    if (event.target == modal && modal.id !== 'calculatorModal') { // Prevent calculator from closing on backdrop click for now
                        closeModal(modal.id);
                    }
                });
            });

            window.addEventListener('keydown', function (event) {
                if (event.key === "Escape" || event.key === "Esc") {
                    document.querySelectorAll('.modal.show').forEach(modal => closeModal(modal.id));
                    if (document.getElementById('sidebar').classList.contains('open')) {
                        closeDrawer(); // Close drawer on Escape key if open
                    }
                }
            });
        }

        // ===== APPLICATION INITIALIZATION =====
        window.onload = function () {
            console.log('Aplikasi Sistem Deposit Dokter sedang diinisialisasi...');
            if (typeof feather !== 'undefined') feather.replace();
            updateConnectionStatus();
            setupEventListeners();

            initializeFirebase();

            setTimeout(() => {
                initAuth();
            }, 150);
        };

        if (typeof feather === 'undefined') {
            console.warn('Feather Icons CDN tidak termuat. Ikon mungkin tidak tampil.');
            window.feather = { replace: () => { } };
        }

    </script>
</body>

</html>
